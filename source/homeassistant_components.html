<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html"><link rel="search" title="Search" href="../search.html"><link rel="next" title="RaspyRFM Hardware Installation Guide" href="raspyrfm_hardware_setup.html"><link rel="prev" title="RaspyRFM Client Manual" href="index.html">

    <!-- Generated with Sphinx 7.4.7 and Furo 2025.12.19 -->
        <title>Home Assistant Components - RaspyRFM Client Manual</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=7bdb33bb" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=8dab3a3b" />
    <link rel="stylesheet" type="text/css" href="../_static/raspyrfm.css?v=594c1320" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  --color-brand-primary: #1e88e5;
  --color-brand-content: #00897b;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #4dd0e1;
  --color-brand-content: #90caf9;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #4dd0e1;
  --color-brand-content: #90caf9;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">RaspyRFM Client Manual</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">RaspyRFM Client Manual</a><input aria-label="Toggle navigation of RaspyRFM Client Manual" checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul class="current">
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Home Assistant Components</a></li>
<li class="toctree-l2"><a class="reference internal" href="raspyrfm_hardware_setup.html">RaspyRFM Hardware Installation Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="ui-guide.html">Home Assistant Experience</a></li>
<li class="toctree-l2"><a class="reference internal" href="ui-showcase.html">UI Showcase</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="raspyrfm_client.html">raspyrfm_client package</a><input aria-label="Toggle navigation of raspyrfm_client package" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="raspyrfm_client.device.html">raspyrfm_client.device package</a><input aria-label="Toggle navigation of raspyrfm_client.device package" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4 has-children"><a class="reference internal" href="raspyrfm_client.device.manufacturer.html">raspyrfm_client.device.manufacturer package</a><input aria-label="Toggle navigation of raspyrfm_client.device.manufacturer package" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="raspyrfm_client.device.manufacturer.bat.html">raspyrfm_client.device.manufacturer.bat package</a></li>
<li class="toctree-l5"><a class="reference internal" href="raspyrfm_client.device.manufacturer.brennenstuhl.html">raspyrfm_client.device.manufacturer.brennenstuhl package</a></li>
<li class="toctree-l5"><a class="reference internal" href="raspyrfm_client.device.manufacturer.elro.html">raspyrfm_client.device.manufacturer.elro package</a></li>
<li class="toctree-l5"><a class="reference internal" href="raspyrfm_client.device.manufacturer.intertechno.html">raspyrfm_client.device.manufacturer.intertechno package</a></li>
<li class="toctree-l5"><a class="reference internal" href="raspyrfm_client.device.manufacturer.intertek.html">raspyrfm_client.device.manufacturer.intertek package</a></li>
<li class="toctree-l5"><a class="reference internal" href="raspyrfm_client.device.manufacturer.mumbi.html">raspyrfm_client.device.manufacturer.mumbi package</a></li>
<li class="toctree-l5"><a class="reference internal" href="raspyrfm_client.device.manufacturer.pollin_electronic.html">raspyrfm_client.device.manufacturer.pollin_electronic package</a></li>
<li class="toctree-l5"><a class="reference internal" href="raspyrfm_client.device.manufacturer.rev.html">raspyrfm_client.device.manufacturer.rev package</a></li>
<li class="toctree-l5"><a class="reference internal" href="raspyrfm_client.device.manufacturer.universal.html">raspyrfm_client.device.manufacturer.universal package</a></li>
<li class="toctree-l5"><a class="reference internal" href="raspyrfm_client.device.manufacturer.vivanco.html">raspyrfm_client.device.manufacturer.vivanco package</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="raspyrfm_client.device.manufacturer.html">raspyrfm_client.device.manufacturer package</a><input aria-label="Toggle navigation of raspyrfm_client.device.manufacturer package" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="raspyrfm_client.device.manufacturer.bat.html">raspyrfm_client.device.manufacturer.bat package</a></li>
<li class="toctree-l4"><a class="reference internal" href="raspyrfm_client.device.manufacturer.brennenstuhl.html">raspyrfm_client.device.manufacturer.brennenstuhl package</a></li>
<li class="toctree-l4"><a class="reference internal" href="raspyrfm_client.device.manufacturer.elro.html">raspyrfm_client.device.manufacturer.elro package</a></li>
<li class="toctree-l4"><a class="reference internal" href="raspyrfm_client.device.manufacturer.intertechno.html">raspyrfm_client.device.manufacturer.intertechno package</a></li>
<li class="toctree-l4"><a class="reference internal" href="raspyrfm_client.device.manufacturer.intertek.html">raspyrfm_client.device.manufacturer.intertek package</a></li>
<li class="toctree-l4"><a class="reference internal" href="raspyrfm_client.device.manufacturer.mumbi.html">raspyrfm_client.device.manufacturer.mumbi package</a></li>
<li class="toctree-l4"><a class="reference internal" href="raspyrfm_client.device.manufacturer.pollin_electronic.html">raspyrfm_client.device.manufacturer.pollin_electronic package</a></li>
<li class="toctree-l4"><a class="reference internal" href="raspyrfm_client.device.manufacturer.rev.html">raspyrfm_client.device.manufacturer.rev package</a></li>
<li class="toctree-l4"><a class="reference internal" href="raspyrfm_client.device.manufacturer.universal.html">raspyrfm_client.device.manufacturer.universal package</a></li>
<li class="toctree-l4"><a class="reference internal" href="raspyrfm_client.device.manufacturer.vivanco.html">raspyrfm_client.device.manufacturer.vivanco package</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="modules.html">raspyrfm_client</a><input aria-label="Toggle navigation of raspyrfm_client" class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="raspyrfm_client.html">raspyrfm_client package</a><input aria-label="Toggle navigation of raspyrfm_client package" class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4 has-children"><a class="reference internal" href="raspyrfm_client.device.html">raspyrfm_client.device package</a><input aria-label="Toggle navigation of raspyrfm_client.device package" class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5 has-children"><a class="reference internal" href="raspyrfm_client.device.manufacturer.html">raspyrfm_client.device.manufacturer package</a><input aria-label="Toggle navigation of raspyrfm_client.device.manufacturer package" class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l6"><a class="reference internal" href="raspyrfm_client.device.manufacturer.bat.html">raspyrfm_client.device.manufacturer.bat package</a></li>
<li class="toctree-l6"><a class="reference internal" href="raspyrfm_client.device.manufacturer.brennenstuhl.html">raspyrfm_client.device.manufacturer.brennenstuhl package</a></li>
<li class="toctree-l6"><a class="reference internal" href="raspyrfm_client.device.manufacturer.elro.html">raspyrfm_client.device.manufacturer.elro package</a></li>
<li class="toctree-l6"><a class="reference internal" href="raspyrfm_client.device.manufacturer.intertechno.html">raspyrfm_client.device.manufacturer.intertechno package</a></li>
<li class="toctree-l6"><a class="reference internal" href="raspyrfm_client.device.manufacturer.intertek.html">raspyrfm_client.device.manufacturer.intertek package</a></li>
<li class="toctree-l6"><a class="reference internal" href="raspyrfm_client.device.manufacturer.mumbi.html">raspyrfm_client.device.manufacturer.mumbi package</a></li>
<li class="toctree-l6"><a class="reference internal" href="raspyrfm_client.device.manufacturer.pollin_electronic.html">raspyrfm_client.device.manufacturer.pollin_electronic package</a></li>
<li class="toctree-l6"><a class="reference internal" href="raspyrfm_client.device.manufacturer.rev.html">raspyrfm_client.device.manufacturer.rev package</a></li>
<li class="toctree-l6"><a class="reference internal" href="raspyrfm_client.device.manufacturer.universal.html">raspyrfm_client.device.manufacturer.universal package</a></li>
<li class="toctree-l6"><a class="reference internal" href="raspyrfm_client.device.manufacturer.vivanco.html">raspyrfm_client.device.manufacturer.vivanco package</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="raspyrfm_client.device.manufacturer.html">raspyrfm_client.device.manufacturer package</a><input aria-label="Toggle navigation of raspyrfm_client.device.manufacturer package" class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="raspyrfm_client.device.manufacturer.bat.html">raspyrfm_client.device.manufacturer.bat package</a></li>
<li class="toctree-l5"><a class="reference internal" href="raspyrfm_client.device.manufacturer.brennenstuhl.html">raspyrfm_client.device.manufacturer.brennenstuhl package</a></li>
<li class="toctree-l5"><a class="reference internal" href="raspyrfm_client.device.manufacturer.elro.html">raspyrfm_client.device.manufacturer.elro package</a></li>
<li class="toctree-l5"><a class="reference internal" href="raspyrfm_client.device.manufacturer.intertechno.html">raspyrfm_client.device.manufacturer.intertechno package</a></li>
<li class="toctree-l5"><a class="reference internal" href="raspyrfm_client.device.manufacturer.intertek.html">raspyrfm_client.device.manufacturer.intertek package</a></li>
<li class="toctree-l5"><a class="reference internal" href="raspyrfm_client.device.manufacturer.mumbi.html">raspyrfm_client.device.manufacturer.mumbi package</a></li>
<li class="toctree-l5"><a class="reference internal" href="raspyrfm_client.device.manufacturer.pollin_electronic.html">raspyrfm_client.device.manufacturer.pollin_electronic package</a></li>
<li class="toctree-l5"><a class="reference internal" href="raspyrfm_client.device.manufacturer.rev.html">raspyrfm_client.device.manufacturer.rev package</a></li>
<li class="toctree-l5"><a class="reference internal" href="raspyrfm_client.device.manufacturer.universal.html">raspyrfm_client.device.manufacturer.universal package</a></li>
<li class="toctree-l5"><a class="reference internal" href="raspyrfm_client.device.manufacturer.vivanco.html">raspyrfm_client.device.manufacturer.vivanco package</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/source/homeassistant_components.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="home-assistant-components">
<h1>Home Assistant Components<a class="headerlink" href="#home-assistant-components" title="Link to this heading">¶</a></h1>
<p>This section documents the backend pieces that power the RaspyRFM
Home Assistant integration.  Each subsection links to the relevant
source files and explains how the pieces collaborate to monitor radio
traffic, learn payloads, and expose entities inside Home Assistant.</p>
<section id="configuration-flow-and-setup">
<h2>Configuration flow and setup<a class="headerlink" href="#configuration-flow-and-setup" title="Link to this heading">¶</a></h2>
<p>RaspyRFM is installed as a config entry.  The integration registers a
config flow that resolves the gateway host name and persists the chosen
UDP port.  Once an entry is created, <code class="docutils literal notranslate"><span class="pre">async_setup_entry</span></code> instantiates
the hub, forwards platform setups, and makes the management panel,
websocket commands, and the <code class="docutils literal notranslate"><span class="pre">raspyrfm.send_action</span></code> service available so
payloads can be replayed from automations.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Config flow for the RaspyRFM integration.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">voluptuous</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">vol</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant</span><span class="w"> </span><span class="kn">import</span> <span class="n">config_entries</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">HomeAssistant</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.const</span><span class="w"> </span><span class="kn">import</span> <span class="n">CONF_HOST</span><span class="p">,</span> <span class="n">CONF_PORT</span><span class="p">,</span> <span class="n">DEFAULT_PORT</span><span class="p">,</span> <span class="n">DOMAIN</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_validate_input</span><span class="p">(</span><span class="n">hass</span><span class="p">:</span> <span class="n">HomeAssistant</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">host</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">CONF_HOST</span><span class="p">]</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">CONF_PORT</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">hass</span><span class="o">.</span><span class="n">async_add_executor_job</span><span class="p">(</span><span class="n">_resolve</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;RaspyRFM (</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="n">port</span><span class="p">}</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RaspyRFMConfigFlow</span><span class="p">(</span><span class="n">config_entries</span><span class="o">.</span><span class="n">ConfigFlow</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">DOMAIN</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle a config flow for RaspyRFM.&quot;&quot;&quot;</span>

    <span class="n">VERSION</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_step_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_input</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">errors</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">user_input</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_validate_input</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hass</span><span class="p">,</span> <span class="n">user_input</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">errors</span><span class="p">[</span><span class="s2">&quot;base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;cannot_connect&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_set_unique_id</span><span class="p">(</span><span class="n">user_input</span><span class="p">[</span><span class="n">CONF_HOST</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_abort_if_unique_id_configured</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_create_entry</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">user_input</span><span class="p">)</span>

        <span class="n">schema</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">Schema</span><span class="p">({</span>
            <span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="n">CONF_HOST</span><span class="p">):</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">vol</span><span class="o">.</span><span class="n">Optional</span><span class="p">(</span><span class="n">CONF_PORT</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_PORT</span><span class="p">):</span> <span class="nb">int</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_show_form</span><span class="p">(</span><span class="n">step_id</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">data_schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_step_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_input</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle YAML import.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_step_user</span><span class="p">(</span><span class="n">user_input</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_get_options_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">:</span> <span class="n">config_entries</span><span class="o">.</span><span class="n">ConfigEntry</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">RaspyRFMOptionsFlow</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RaspyRFMOptionsFlow</span><span class="p">(</span><span class="n">config_entries</span><span class="o">.</span><span class="n">OptionsFlow</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle options flow for RaspyRFM.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">:</span> <span class="n">config_entries</span><span class="o">.</span><span class="n">ConfigEntry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_entry</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_step_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_input</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">errors</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">user_input</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">CONF_HOST</span><span class="p">:</span> <span class="n">user_input</span><span class="p">[</span><span class="n">CONF_HOST</span><span class="p">],</span>
                <span class="n">CONF_PORT</span><span class="p">:</span> <span class="n">user_input</span><span class="p">[</span><span class="n">CONF_PORT</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hass</span><span class="o">.</span><span class="n">config_entries</span><span class="o">.</span><span class="n">async_update_entry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_entry</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">new_data</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_create_entry</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{})</span>

        <span class="n">schema</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">Schema</span><span class="p">({</span>
            <span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="n">CONF_HOST</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_entry</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">CONF_HOST</span><span class="p">)):</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="n">CONF_PORT</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_entry</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">CONF_PORT</span><span class="p">,</span> <span class="n">DEFAULT_PORT</span><span class="p">)):</span> <span class="nb">int</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_show_form</span><span class="p">(</span><span class="n">step_id</span><span class="o">=</span><span class="s2">&quot;init&quot;</span><span class="p">,</span> <span class="n">data_schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Home Assistant integration for the RaspyRFM gateway.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">voluptuous</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">vol</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.config_entries</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigEntry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">HomeAssistant</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigEntryNotReady</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">config_validation</span> <span class="k">as</span> <span class="n">cv</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.const</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ATTR_ACTION</span><span class="p">,</span>
    <span class="n">ATTR_DEVICE_ID</span><span class="p">,</span>
    <span class="n">DATA_SERVICE_REGISTERED</span><span class="p">,</span>
    <span class="n">DOMAIN</span><span class="p">,</span>
    <span class="n">PLATFORMS</span><span class="p">,</span>
    <span class="n">SERVICE_SEND_ACTION</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.hub</span><span class="w"> </span><span class="kn">import</span> <span class="n">RaspyRFMHub</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.panel</span><span class="w"> </span><span class="kn">import</span> <span class="n">async_register_panel</span><span class="p">,</span> <span class="n">async_unregister_panel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.websocket</span><span class="w"> </span><span class="kn">import</span> <span class="n">async_register_websocket_handlers</span>

<span class="n">_LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">SEND_ACTION_SCHEMA</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">Schema</span><span class="p">({</span>
    <span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="n">ATTR_DEVICE_ID</span><span class="p">):</span> <span class="n">cv</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
    <span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="n">ATTR_ACTION</span><span class="p">):</span> <span class="n">cv</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
<span class="p">})</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_setup_entry</span><span class="p">(</span><span class="n">hass</span><span class="p">:</span> <span class="n">HomeAssistant</span><span class="p">,</span> <span class="n">entry</span><span class="p">:</span> <span class="n">ConfigEntry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set up RaspyRFM from a config entry.&quot;&quot;&quot;</span>
    <span class="n">hub</span> <span class="o">=</span> <span class="n">RaspyRFMHub</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">hub</span><span class="o">.</span><span class="n">async_setup</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConfigEntryNotReady</span><span class="p">(</span><span class="s2">&quot;Unable to initialise RaspyRFM hub&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

    <span class="n">hass</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">DOMAIN</span><span class="p">,</span> <span class="p">{})[</span><span class="n">entry</span><span class="o">.</span><span class="n">entry_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">hub</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">hass</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">DOMAIN</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">DATA_SERVICE_REGISTERED</span><span class="p">):</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_async_handle_send_action</span><span class="p">(</span><span class="n">call</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">device_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ATTR_DEVICE_ID</span><span class="p">]</span>
            <span class="n">action</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ATTR_ACTION</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">hass</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">DOMAIN</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">candidate</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">get_device</span><span class="p">(</span><span class="n">device_id</span><span class="p">):</span>
</pre></div>
</div>
</section>
<section id="gateway-and-hub-orchestration">
<h2>Gateway and hub orchestration<a class="headerlink" href="#gateway-and-hub-orchestration" title="Link to this heading">¶</a></h2>
<p>The <code class="xref py py-class docutils literal notranslate"><span class="pre">RaspyRFMGateway</span></code> wraps the
UDP socket used by the hardware bridge.  The hub owns a gateway instance
and coordinates persistent storage, signal learning, and entity updates
via Home Assistant dispatcher signals.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Helpers for interacting with the RaspyRFM UDP gateway.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">HomeAssistant</span>

<span class="n">_LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RaspyRFMGateway</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstraction around the UDP based RaspyRFM gateway.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hass</span><span class="p">:</span> <span class="n">HomeAssistant</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hass</span> <span class="o">=</span> <span class="n">hass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_port</span> <span class="o">=</span> <span class="n">port</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">host</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the configured host.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_host</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">port</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the configured port.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update connection details.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_port</span> <span class="o">=</span> <span class="n">port</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_send_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send a raw payload to the gateway via UDP.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;Gateway host not configured&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_send</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="p">))</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hass</span><span class="o">.</span><span class="n">async_add_executor_job</span><span class="p">(</span><span class="n">_send</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_ping</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attempt to contact the gateway.&quot;&quot;&quot;</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_send_raw</span><span class="p">(</span><span class="s2">&quot;PING&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Core hub object for the RaspyRFM integration.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.config_entries</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigEntry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">HomeAssistant</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.helpers.dispatcher</span><span class="w"> </span><span class="kn">import</span> <span class="n">async_dispatcher_send</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.const</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">CONF_HOST</span><span class="p">,</span>
    <span class="n">CONF_PORT</span><span class="p">,</span>
    <span class="n">DEFAULT_PORT</span><span class="p">,</span>
    <span class="n">SIGNAL_DEVICE_REGISTRY_UPDATED</span><span class="p">,</span>
    <span class="n">SIGNAL_DEVICE_REMOVED</span><span class="p">,</span>
    <span class="n">SIGNAL_LEARNING_STATE</span><span class="p">,</span>
    <span class="n">SIGNAL_SIGNAL_RECEIVED</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.storage</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">RaspyRFMDeviceEntry</span><span class="p">,</span>
    <span class="n">RaspyRFMDeviceStorage</span><span class="p">,</span>
    <span class="n">RaspyRFMSignalMapStorage</span><span class="p">,</span>
    <span class="n">RaspyRFMSignalMapping</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.gateway</span><span class="w"> </span><span class="kn">import</span> <span class="n">RaspyRFMGateway</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.learn</span><span class="w"> </span><span class="kn">import</span> <span class="n">LearnManager</span><span class="p">,</span> <span class="n">LearnedSignal</span>

<span class="n">_LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@dataclass</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ActiveSignal</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Representation of a signal currently known to the hub.&quot;&quot;&quot;</span>

    <span class="n">signal</span><span class="p">:</span> <span class="n">LearnedSignal</span>
    <span class="n">received_at</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">source</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RaspyRFMHub</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Bridge between Home Assistant and a RaspyRFM gateway.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hass</span><span class="p">:</span> <span class="n">HomeAssistant</span><span class="p">,</span> <span class="n">entry</span><span class="p">:</span> <span class="n">ConfigEntry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hass</span> <span class="o">=</span> <span class="n">hass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_entry</span> <span class="o">=</span> <span class="n">entry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gateway</span> <span class="o">=</span> <span class="n">RaspyRFMGateway</span><span class="p">(</span>
            <span class="n">hass</span><span class="p">,</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">CONF_HOST</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">CONF_PORT</span><span class="p">,</span> <span class="n">DEFAULT_PORT</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span> <span class="o">=</span> <span class="n">RaspyRFMDeviceStorage</span><span class="p">(</span><span class="n">hass</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_map_storage</span> <span class="o">=</span> <span class="n">RaspyRFMSignalMapStorage</span><span class="p">(</span><span class="n">hass</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_learn_manager</span> <span class="o">=</span> <span class="n">LearnManager</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active_signals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ActiveSignal</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signals_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gateway</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RaspyRFMGateway</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the gateway helper object.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">storage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RaspyRFMDeviceStorage</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the persistent storage helper.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">learn_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LearnManager</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the signal learning manager.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_learn_manager</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialise hub resources.&quot;&quot;&quot;</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">async_load</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_storage</span><span class="o">.</span><span class="n">async_load</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_unload</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Unload hub resources.&quot;&quot;&quot;</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_learn_manager</span><span class="o">.</span><span class="n">async_stop</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">async_unload</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_storage</span><span class="o">.</span><span class="n">async_unload</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_update_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">:</span> <span class="n">ConfigEntry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle entry updates.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_entry</span> <span class="o">=</span> <span class="n">entry</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway</span><span class="o">.</span><span class="n">async_update</span><span class="p">(</span>  <span class="c1"># type: ignore[no-untyped-call]</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">CONF_HOST</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="n">entry</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">CONF_PORT</span><span class="p">,</span> <span class="n">DEFAULT_PORT</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_start_learning</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start a learning session.&quot;&quot;&quot;</span>

        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signals_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_active_signals</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_learn_manager</span><span class="o">.</span><span class="n">async_start</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_stop_learning</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop an active learning session.&quot;&quot;&quot;</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_learn_manager</span><span class="o">.</span><span class="n">async_stop</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">iter_devices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">RaspyRFMDeviceEntry</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all configured devices.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">iter_devices</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">iter_signal_mappings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">RaspyRFMSignalMapping</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all stored signal mappings.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_storage</span><span class="o">.</span><span class="n">iter_mappings</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RaspyRFMDeviceEntry</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a device by id.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">get_device</span><span class="p">(</span><span class="n">device_id</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_create_device</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">device_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">signals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RaspyRFMDeviceEntry</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new device entry from learned signals.&quot;&quot;&quot;</span>

        <span class="n">device</span> <span class="o">=</span> <span class="n">RaspyRFMDeviceEntry</span><span class="p">(</span>
            <span class="n">device_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">device_type</span><span class="o">=</span><span class="n">device_type</span><span class="p">,</span>
            <span class="n">signals</span><span class="o">=</span><span class="n">signals</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span> <span class="ow">or</span> <span class="p">{},</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">async_add_or_update</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">async_dispatcher_send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hass</span><span class="p">,</span> <span class="n">SIGNAL_DEVICE_REGISTRY_UPDATED</span><span class="p">,</span> <span class="n">device</span><span class="o">.</span><span class="n">device_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">device</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_remove_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove a device entry.&quot;&quot;&quot;</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">async_remove</span><span class="p">(</span><span class="n">device_id</span><span class="p">)</span>
        <span class="n">async_dispatcher_send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hass</span><span class="p">,</span> <span class="n">SIGNAL_DEVICE_REMOVED</span><span class="p">,</span> <span class="n">device_id</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_set_signal_mapping</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">payload</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">category</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">linked_devices</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RaspyRFMSignalMapping</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Store metadata describing a learned payload.&quot;&quot;&quot;</span>

        <span class="n">mapping</span> <span class="o">=</span> <span class="n">RaspyRFMSignalMapping</span><span class="p">(</span>
            <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span> <span class="ow">or</span> <span class="n">payload</span><span class="p">,</span>
            <span class="n">linked_devices</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">linked_devices</span> <span class="ow">or</span> <span class="p">[]),</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_storage</span><span class="o">.</span><span class="n">async_set</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mapping</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_remove_signal_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete mapping metadata for a payload.&quot;&quot;&quot;</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_storage</span><span class="o">.</span><span class="n">async_remove</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_list_signal_mappings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a serialisable mapping overview.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">mapping</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_storage</span><span class="o">.</span><span class="n">iter_mappings</span><span class="p">()]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_handle_learned_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">:</span> <span class="n">LearnedSignal</span><span class="p">,</span> <span class="n">addr</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle a signal received during a learning session.&quot;&quot;&quot;</span>

        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signals_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_active_signals</span><span class="p">[</span><span class="n">signal</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">ActiveSignal</span><span class="p">(</span>
                <span class="n">signal</span><span class="o">=</span><span class="n">signal</span><span class="p">,</span> <span class="n">received_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span> <span class="n">source</span><span class="o">=</span><span class="n">addr</span>
            <span class="p">)</span>
        <span class="n">async_dispatcher_send</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hass</span><span class="p">,</span>
            <span class="n">SIGNAL_SIGNAL_RECEIVED</span><span class="p">,</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_match_devices</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_maybe_match_devices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">:</span> <span class="n">LearnedSignal</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Match a learned signal with configured devices and fire updates.&quot;&quot;&quot;</span>

        <span class="n">matched</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">iter_devices</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">matches_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">payload</span><span class="p">):</span>
                <span class="n">matched</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">device_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">device_id</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
            <span class="n">async_dispatcher_send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hass</span><span class="p">,</span> <span class="n">SIGNAL_DEVICE_REGISTRY_UPDATED</span><span class="p">,</span> <span class="n">device_id</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_list_active_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a snapshot of all active signals.&quot;&quot;&quot;</span>

        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signals_lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">signal</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_signals</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_reload_devices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reload device information from disk.&quot;&quot;&quot;</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">async_load</span><span class="p">()</span>
        <span class="n">async_dispatcher_send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hass</span><span class="p">,</span> <span class="n">SIGNAL_DEVICE_REGISTRY_UPDATED</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_record_learning_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Announce a change of the learning state.&quot;&quot;&quot;</span>

        <span class="n">async_dispatcher_send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hass</span><span class="p">,</span> <span class="n">SIGNAL_LEARNING_STATE</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="n">active</span><span class="p">})</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_send_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send a raw UDP payload to the gateway.&quot;&quot;&quot;</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway</span><span class="o">.</span><span class="n">async_send_raw</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_send_device_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send a stored signal for the given device.&quot;&quot;&quot;</span>

        <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="o">.</span><span class="n">get_device</span><span class="p">(</span><span class="n">device_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown device: </span><span class="si">{</span><span class="n">device_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="signal-learning-pipeline">
<h2>Signal learning pipeline<a class="headerlink" href="#signal-learning-pipeline" title="Link to this heading">¶</a></h2>
<p>The <code class="xref py py-class docutils literal notranslate"><span class="pre">LearnManager</span></code> binds a UDP
listener to <code class="docutils literal notranslate"><span class="pre">DEFAULT_LISTEN_PORT</span></code> (49881) and streams payloads into the
hub.  Incoming packets are normalised into <code class="docutils literal notranslate"><span class="pre">LearnedSignal</span></code> dataclasses
and broadcast over dispatcher events so that the UI and entity platforms
receive live updates.  Each payload is fingerprinted against the
<code class="docutils literal notranslate"><span class="pre">raspyrfm-client</span></code> device library using the <code class="docutils literal notranslate"><span class="pre">classifier</span></code> helper, which
allows the UI to suggest an entity type even when users have not labelled
the signal yet.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Signal learning helper for the RaspyRFM integration.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">HomeAssistant</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.classifier</span><span class="w"> </span><span class="kn">import</span> <span class="n">classify_payload</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.const</span><span class="w"> </span><span class="kn">import</span> <span class="n">DEFAULT_LISTEN_PORT</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.hub</span><span class="w"> </span><span class="kn">import</span> <span class="n">RaspyRFMHub</span>

<span class="n">_LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@dataclass</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LearnedSignal</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Representation of a learned radio signal.&quot;&quot;&quot;</span>

    <span class="n">uid</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">payload</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">received</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a serialisable representation.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;uid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span>
            <span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span>
            <span class="s2">&quot;received&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">received</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="p">}</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RaspyRFMLearnProtocol</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">DatagramProtocol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Asyncio datagram protocol for capturing signals.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">:</span> <span class="n">LearnManager</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span> <span class="o">=</span> <span class="n">manager</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">datagram_received</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">addr</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">payload</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">async_process_datagram</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>


<span class="k">class</span><span class="w"> </span><span class="nc">LearnManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manage RaspyRFM learning sessions.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hass</span><span class="p">:</span> <span class="n">HomeAssistant</span><span class="p">,</span> <span class="n">hub</span><span class="p">:</span> <span class="n">RaspyRFMHub</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hass</span> <span class="o">=</span> <span class="n">hass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hub</span> <span class="o">=</span> <span class="n">hub</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">transports</span><span class="o">.</span><span class="n">DatagramTransport</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_listen_port</span> <span class="o">=</span> <span class="n">DEFAULT_LISTEN_PORT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">LearnedSignal</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return whether learning is active.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start listening for incoming datagrams.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_datagram_endpoint</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">RaspyRFMLearnProtocol</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">local_addr</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listen_port</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signals</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hub</span><span class="o">.</span><span class="n">async_send_raw</span><span class="p">(</span><span class="s2">&quot;RXSTART&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Unable to send RXSTART command to gateway&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hub</span><span class="o">.</span><span class="n">async_record_learning_state</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop listening for signals.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hub</span><span class="o">.</span><span class="n">async_send_raw</span><span class="p">(</span><span class="s2">&quot;RXSTOP&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Unable to send RXSTOP command to gateway&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hub</span><span class="o">.</span><span class="n">async_record_learning_state</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_process_datagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">addr</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process an incoming UDP datagram.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">payload</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">signal</span> <span class="o">=</span> <span class="n">LearnedSignal</span><span class="p">(</span>
            <span class="n">uid</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;sig_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_signals</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
            <span class="n">received</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
            <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
        <span class="p">)</span>
        <span class="n">classification</span> <span class="o">=</span> <span class="n">classify_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">classification</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;classification&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">classification</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hub</span><span class="o">.</span><span class="n">async_handle_learned_signal</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_list_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of captured signals.&quot;&quot;&quot;</span>

        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">signal</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">signal</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signals</span><span class="p">]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_clear_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Signal classification helpers for RaspyRFM payloads.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">raspyrfm_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">RaspyRFMClient</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">raspyrfm_client.device_implementations.controlunit.actions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Action</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SignalFingerprint</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fingerprint describing a payload independent of the channel config.&quot;&quot;&quot;</span>

    <span class="n">repetitions</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">gap</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">timebase</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">pulse_count</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">min_pulse</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">max_pulse</span><span class="p">:</span> <span class="nb">int</span>


<span class="nd">@dataclass</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SignalClassification</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Classification result for a payload.&quot;&quot;&quot;</span>

    <span class="n">actions</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Action</span><span class="p">]</span>
    <span class="n">suggested_type</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a serialisable representation.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;actions&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">),</span>
            <span class="s2">&quot;suggested_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">suggested_type</span><span class="p">,</span>
        <span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">classify_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SignalClassification</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a best-effort classification for a payload string.&quot;&quot;&quot;</span>

    <span class="n">fingerprint</span> <span class="o">=</span> <span class="n">_fingerprint_from_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fingerprint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">action_candidates</span> <span class="o">=</span> <span class="n">_fingerprint_action_map</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fingerprint</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">action_candidates</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">suggested_type</span> <span class="o">=</span> <span class="n">_actions_to_device_type</span><span class="p">(</span><span class="n">action_candidates</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">SignalClassification</span><span class="p">(</span><span class="n">actions</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">action_candidates</span><span class="p">),</span> <span class="n">suggested_type</span><span class="o">=</span><span class="n">suggested_type</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_actions_to_device_type</span><span class="p">(</span><span class="n">actions</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Action</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Translate a collection of supported actions into a RaspyRFM device type.&quot;&quot;&quot;</span>

    <span class="n">action_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">{</span><span class="n">Action</span><span class="o">.</span><span class="n">BRIGHT</span><span class="p">,</span> <span class="n">Action</span><span class="o">.</span><span class="n">DIMM</span><span class="p">}</span> <span class="o">&amp;</span> <span class="n">action_set</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;light&quot;</span>
    <span class="k">if</span> <span class="n">Action</span><span class="o">.</span><span class="n">ON</span> <span class="ow">in</span> <span class="n">action_set</span> <span class="ow">and</span> <span class="n">Action</span><span class="o">.</span><span class="n">OFF</span> <span class="ow">in</span> <span class="n">action_set</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;switch&quot;</span>
    <span class="k">if</span> <span class="n">action_set</span> <span class="o">==</span> <span class="p">{</span><span class="n">Action</span><span class="o">.</span><span class="n">ON</span><span class="p">}:</span>
        <span class="k">return</span> <span class="s2">&quot;button&quot;</span>
    <span class="k">if</span> <span class="n">action_set</span> <span class="o">&gt;=</span> <span class="p">{</span><span class="n">Action</span><span class="o">.</span><span class="n">PAIR</span><span class="p">}</span> <span class="ow">or</span> <span class="n">action_set</span> <span class="o">&gt;=</span> <span class="p">{</span><span class="n">Action</span><span class="o">.</span><span class="n">UNPAIR</span><span class="p">}:</span>
        <span class="c1"># Pairing remotes act as buttons in the Home Assistant context.</span>
        <span class="k">return</span> <span class="s2">&quot;button&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;universal&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_fingerprint_from_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SignalFingerprint</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse a payload into a fingerprint for comparison with the library table.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">payload</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">body</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">body</span><span class="p">:</span>
        <span class="c1"># Strip transport prefix (e.g. ``TXP:`` or ``RXP:``)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">token</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">repetitions</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">gap</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">timebase</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">pair_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">pulses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">6</span> <span class="o">+</span> <span class="n">pair_count</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pulses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pulses</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">min_pulse</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pulses</span><span class="p">)</span>
    <span class="n">max_pulse</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pulses</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">SignalFingerprint</span><span class="p">(</span>
        <span class="n">repetitions</span><span class="o">=</span><span class="n">repetitions</span><span class="p">,</span>
        <span class="n">gap</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span>
        <span class="n">timebase</span><span class="o">=</span><span class="n">timebase</span><span class="p">,</span>
        <span class="n">pulse_count</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pulses</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
        <span class="n">min_pulse</span><span class="o">=</span><span class="n">min_pulse</span><span class="p">,</span>
        <span class="n">max_pulse</span><span class="o">=</span><span class="n">max_pulse</span><span class="p">,</span>
    <span class="p">)</span>


<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_fingerprint_action_map</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">SignalFingerprint</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="n">Action</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a lookup table for the available payload fingerprints.&quot;&quot;&quot;</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">RaspyRFMClient</span><span class="p">()</span>
    <span class="n">mapping</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">SignalFingerprint</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="n">Action</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">manufacturer</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">get_supported_controlunit_manufacturers</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">get_supported_controlunit_models</span><span class="p">(</span><span class="n">manufacturer</span><span class="p">):</span>
            <span class="n">device</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_controlunit</span><span class="p">(</span><span class="n">manufacturer</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">default_config</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">key</span><span class="p">:</span> <span class="n">_default_value</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">regex</span> <span class="ow">in</span> <span class="n">device</span><span class="o">.</span><span class="n">get_channel_config_args</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">device</span><span class="o">.</span><span class="n">set_channel_config</span><span class="p">(</span><span class="o">**</span><span class="n">default_config</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>  <span class="c1"># pragma: no cover - defensive fallback</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Unable to build default configuration for </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">manufacturer</span><span class="p">,</span>
                    <span class="n">model</span><span class="p">,</span>
                    <span class="n">err</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">device</span><span class="o">.</span><span class="n">get_supported_actions</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pulses</span><span class="p">,</span> <span class="n">repetitions</span><span class="p">,</span> <span class="n">timebase</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">get_pulse_data</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>  <span class="c1"># pragma: no cover - defensive fallback</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;Unable to build fingerprint for </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> action </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">manufacturer</span><span class="p">,</span>
                        <span class="n">model</span><span class="p">,</span>
                        <span class="n">action</span><span class="p">,</span>
                        <span class="n">err</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">gap</span> <span class="o">=</span> <span class="mi">5600</span>  <span class="c1"># The RaspyRFM gateways always inject this constant gap.</span>
                <span class="n">min_pulse</span><span class="p">,</span> <span class="n">max_pulse</span> <span class="o">=</span> <span class="n">_pulse_bounds</span><span class="p">(</span><span class="n">pulses</span><span class="p">)</span>
                <span class="n">fingerprint</span> <span class="o">=</span> <span class="n">SignalFingerprint</span><span class="p">(</span>
                    <span class="n">repetitions</span><span class="o">=</span><span class="n">repetitions</span><span class="p">,</span>
                    <span class="n">gap</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span>
                    <span class="n">timebase</span><span class="o">=</span><span class="n">timebase</span><span class="p">,</span>
                    <span class="n">pulse_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">pulses</span><span class="p">),</span>
                    <span class="n">min_pulse</span><span class="o">=</span><span class="n">min_pulse</span><span class="p">,</span>
                    <span class="n">max_pulse</span><span class="o">=</span><span class="n">max_pulse</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">mapping</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">fingerprint</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mapping</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_pulse_bounds</span><span class="p">(</span><span class="n">pulses</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the minimum and maximum pulse length from a sequence.&quot;&quot;&quot;</span>

    <span class="n">minima</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">maxima</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span> <span class="ow">in</span> <span class="n">pulses</span><span class="p">:</span>
        <span class="n">minima</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">))</span>
        <span class="n">maxima</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">minima</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxima</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_default_value</span><span class="p">(</span><span class="n">regex</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a deterministic default value that satisfies a configuration regex.&quot;&quot;&quot;</span>

    <span class="n">pattern</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pattern</span> <span class="o">==</span> <span class="s2">&quot;[01]&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;0&quot;</span>
    <span class="k">if</span> <span class="n">pattern</span> <span class="o">==</span> <span class="s2">&quot;[1-4]&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;1&quot;</span>
    <span class="k">if</span> <span class="n">pattern</span> <span class="o">==</span> <span class="s2">&quot;[1-3]&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;1&quot;</span>
    <span class="k">if</span> <span class="n">pattern</span> <span class="o">==</span> <span class="s2">&quot;[A-D]&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;A&quot;</span>
    <span class="k">if</span> <span class="n">pattern</span> <span class="o">==</span> <span class="s2">&quot;[A-C]&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;A&quot;</span>
    <span class="k">if</span> <span class="n">pattern</span> <span class="o">==</span> <span class="s2">&quot;[A-E]&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;A&quot;</span>
    <span class="k">if</span> <span class="n">pattern</span> <span class="o">==</span> <span class="s2">&quot;[A-P]&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;A&quot;</span>
    <span class="k">if</span> <span class="n">pattern</span> <span class="o">==</span> <span class="s2">&quot;[01fF]&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;0&quot;</span>
    <span class="k">if</span> <span class="n">pattern</span> <span class="o">==</span> <span class="s2">&quot;[01]</span><span class="si">{12}</span><span class="s2">&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;0&quot;</span> <span class="o">*</span> <span class="mi">12</span>
    <span class="k">if</span> <span class="n">pattern</span> <span class="o">==</span> <span class="s2">&quot;[01]</span><span class="si">{26}</span><span class="s2">&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;0&quot;</span> <span class="o">*</span> <span class="mi">26</span>
    <span class="k">if</span> <span class="n">pattern</span> <span class="o">==</span> <span class="s2">&quot;[0-9A-F]</span><span class="si">{5}</span><span class="s2">&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;00000&quot;</span>
    <span class="k">if</span> <span class="n">pattern</span> <span class="o">==</span> <span class="s2">&quot;([1-9]|0[1-9]|1[0-6])&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;01&quot;</span>

    <span class="c1"># Fall back to the first character when the pattern is a simple character set.</span>
    <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pattern</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">):</span>
        <span class="n">characters</span> <span class="o">=</span> <span class="n">pattern</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">characters</span> <span class="ow">and</span> <span class="n">characters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;^&quot;</span><span class="p">:</span>
</pre></div>
</div>
</section>
<section id="persistent-storage-and-device-registry">
<h2>Persistent storage and device registry<a class="headerlink" href="#persistent-storage-and-device-registry" title="Link to this heading">¶</a></h2>
<p>Two storage helpers manage device definitions and optional metadata about
captured payloads.  The <code class="docutils literal notranslate"><span class="pre">RaspyRFMDeviceStorage</span></code> class keeps track of
all entity types created from learned signals, including switches, lights,
button groups, and universal listeners, while <code class="docutils literal notranslate"><span class="pre">RaspyRFMSignalMapStorage</span></code>
stores labels, semantic categories, and links between payloads and devices.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Persistent storage helpers for RaspyRFM devices.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">HomeAssistant</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.helpers.storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">Store</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.const</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">MAPPING_CATEGORIES</span><span class="p">,</span>
    <span class="n">MAPPING_STORAGE_KEY</span><span class="p">,</span>
    <span class="n">MAPPING_STORAGE_VERSION</span><span class="p">,</span>
    <span class="n">STORAGE_KEY</span><span class="p">,</span>
    <span class="n">STORAGE_VERSION</span><span class="p">,</span>
<span class="p">)</span>


<span class="nd">@dataclass</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RaspyRFMDeviceEntry</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Representation of a configured device.&quot;&quot;&quot;</span>

    <span class="n">device_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">device_type</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">signals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a dictionary representation.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;device_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">device_id</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;device_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">device_type</span><span class="p">,</span>
            <span class="s2">&quot;signals&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">signals</span><span class="p">,</span>
            <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">matches_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if the payload matches this device.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">payload</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;RaspyRFMDeviceEntry&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an instance from stored data.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">device_id</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;device_id&quot;</span><span class="p">],</span>
            <span class="n">name</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
            <span class="n">device_type</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device_type&quot;</span><span class="p">,</span> <span class="s2">&quot;switch&quot;</span><span class="p">),</span>
            <span class="n">signals</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;signals&quot;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{}),</span>
        <span class="p">)</span>


<span class="nd">@dataclass</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RaspyRFMSignalMapping</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Representation of a learned signal mapping.&quot;&quot;&quot;</span>

    <span class="n">payload</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">category</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">label</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">linked_devices</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MAPPING_CATEGORIES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown mapping category: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a serialisable form.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span>
            <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
            <span class="s2">&quot;linked_devices&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">linked_devices</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;RaspyRFMSignalMapping&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an instance from stored data.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">payload</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;payload&quot;</span><span class="p">],</span>
            <span class="n">category</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">),</span>
            <span class="n">label</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
            <span class="n">linked_devices</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;linked_devices&quot;</span><span class="p">,</span> <span class="p">[])),</span>
        <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RaspyRFMDeviceStorage</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Storage helper managing device persistence.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hass</span><span class="p">:</span> <span class="n">HomeAssistant</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hass</span> <span class="o">=</span> <span class="n">hass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span> <span class="n">Store</span> <span class="o">=</span> <span class="n">Store</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">STORAGE_VERSION</span><span class="p">,</span> <span class="n">STORAGE_KEY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_devices</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RaspyRFMDeviceEntry</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load device information from disk.&quot;&quot;&quot;</span>

        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">async_load</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_devices</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">return</span>

        <span class="n">devices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RaspyRFMDeviceEntry</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">RaspyRFMDeviceEntry</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;devices&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_devices</span> <span class="o">=</span> <span class="p">{</span><span class="n">device</span><span class="o">.</span><span class="n">device_id</span><span class="p">:</span> <span class="n">device</span> <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_unload</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Flush changes to disk.&quot;&quot;&quot;</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">async_save</span><span class="p">({</span><span class="s2">&quot;devices&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">device</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_devices</span><span class="o">.</span><span class="n">values</span><span class="p">()]})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">iter_devices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">RaspyRFMDeviceEntry</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate over all devices.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_devices</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">iter_devices_by_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">RaspyRFMDeviceEntry</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate over devices of a specific type.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">device</span> <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_devices</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">device_type</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RaspyRFMDeviceEntry</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a device by id.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_devices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">device_id</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_add_or_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">RaspyRFMDeviceEntry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Persist a device entry.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_devices</span><span class="p">[</span><span class="n">device</span><span class="o">.</span><span class="n">device_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">device</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">async_save</span><span class="p">({</span><span class="s2">&quot;devices&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_devices</span><span class="o">.</span><span class="n">values</span><span class="p">()]})</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove a device entry.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">device_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_devices</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_devices</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">device_id</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">async_save</span><span class="p">({</span><span class="s2">&quot;devices&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_devices</span><span class="o">.</span><span class="n">values</span><span class="p">()]})</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RaspyRFMSignalMapStorage</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Storage helper for signal mapping metadata.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hass</span><span class="p">:</span> <span class="n">HomeAssistant</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span> <span class="o">=</span> <span class="n">Store</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">MAPPING_STORAGE_VERSION</span><span class="p">,</span> <span class="n">MAPPING_STORAGE_KEY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mappings</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RaspyRFMSignalMapping</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load mapping state from disk.&quot;&quot;&quot;</span>

        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">async_load</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mappings</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">return</span>

        <span class="n">entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">RaspyRFMSignalMapping</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mappings&quot;</span><span class="p">,</span> <span class="p">[])]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mappings</span> <span class="o">=</span> <span class="p">{</span><span class="n">entry</span><span class="o">.</span><span class="n">payload</span><span class="p">:</span> <span class="n">entry</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_unload</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Persist mapping state to disk.&quot;&quot;&quot;</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">async_save</span><span class="p">({</span><span class="s2">&quot;mappings&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mappings</span><span class="o">.</span><span class="n">values</span><span class="p">()]})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">iter_mappings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">RaspyRFMSignalMapping</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate over all known mappings.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mappings</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RaspyRFMSignalMapping</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return mapping information for a payload if present.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mappings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">:</span> <span class="n">RaspyRFMSignalMapping</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Store or update a mapping entry.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mappings</span><span class="p">[</span><span class="n">mapping</span><span class="o">.</span><span class="n">payload</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">async_save</span><span class="p">({</span><span class="s2">&quot;mappings&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mappings</span><span class="o">.</span><span class="n">values</span><span class="p">()]})</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove a mapping entry.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">payload</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mappings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mappings</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">async_save</span><span class="p">({</span><span class="s2">&quot;mappings&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mappings</span><span class="o">.</span><span class="n">values</span><span class="p">()]})</span>
</pre></div>
</div>
</section>
<section id="entity-platforms">
<h2>Entity platforms<a class="headerlink" href="#entity-platforms" title="Link to this heading">¶</a></h2>
<p>All entities share a base class that listens for dispatcher updates when
devices change.  The entity platforms iterate over stored devices, create
entities on demand, and react to live signal messages from the learning
pipeline.  Besides switches and binary sensors the integration now exposes
a light platform for dimmable actuators, a button platform that creates one
entity per stored action, and a universal sensor that records and replays
raw payloads when no fingerprint matches.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Base entity classes for the RaspyRFM integration.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.helpers.dispatcher</span><span class="w"> </span><span class="kn">import</span> <span class="n">async_dispatcher_connect</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.helpers.entity</span><span class="w"> </span><span class="kn">import</span> <span class="n">Entity</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.const</span><span class="w"> </span><span class="kn">import</span> <span class="n">DOMAIN</span><span class="p">,</span> <span class="n">SIGNAL_DEVICE_REGISTRY_UPDATED</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.hub</span><span class="w"> </span><span class="kn">import</span> <span class="n">RaspyRFMHub</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">RaspyRFMDeviceEntry</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RaspyRFMEntity</span><span class="p">(</span><span class="n">Entity</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Common representation of a RaspyRFM entity.&quot;&quot;&quot;</span>

    <span class="n">_attr_should_poll</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hub</span><span class="p">:</span> <span class="n">RaspyRFMHub</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">RaspyRFMDeviceEntry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hub</span> <span class="o">=</span> <span class="n">hub</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unsub_dispatcher</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_added_to_hass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">async_added_to_hass</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_handle_update</span><span class="p">(</span><span class="n">device_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">device_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">device_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">device_id</span><span class="p">:</span>
                <span class="n">new_device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hub</span><span class="o">.</span><span class="n">get_device</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">device_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_device</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_device</span> <span class="o">=</span> <span class="n">new_device</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">async_write_ha_state</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_unsub_dispatcher</span> <span class="o">=</span> <span class="n">async_dispatcher_connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hass</span><span class="p">,</span> <span class="n">SIGNAL_DEVICE_REGISTRY_UPDATED</span><span class="p">,</span> <span class="n">_handle_update</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_will_remove_from_hass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unsub_dispatcher</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unsub_dispatcher</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unsub_dispatcher</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">async_will_remove_from_hass</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">device_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;identifiers&quot;</span><span class="p">:</span> <span class="p">{(</span><span class="n">DOMAIN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hub</span><span class="o">.</span><span class="n">gateway</span><span class="o">.</span><span class="n">host</span><span class="p">)},</span>
            <span class="s2">&quot;manufacturer&quot;</span><span class="p">:</span> <span class="s2">&quot;Seegel Systeme&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;RaspyRFM&quot;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">unique_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">device_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Switch platform for RaspyRFM.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.components.switch</span><span class="w"> </span><span class="kn">import</span> <span class="n">SwitchEntity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">callback</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.helpers.dispatcher</span><span class="w"> </span><span class="kn">import</span> <span class="n">async_dispatcher_connect</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.const</span><span class="w"> </span><span class="kn">import</span> <span class="n">DOMAIN</span><span class="p">,</span> <span class="n">SIGNAL_DEVICE_REGISTRY_UPDATED</span><span class="p">,</span> <span class="n">SIGNAL_SIGNAL_RECEIVED</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.entity</span><span class="w"> </span><span class="kn">import</span> <span class="n">RaspyRFMEntity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.hub</span><span class="w"> </span><span class="kn">import</span> <span class="n">RaspyRFMHub</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">RaspyRFMDeviceEntry</span>


<span class="n">_LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_setup_entry</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">async_add_entities</span><span class="p">):</span>
    <span class="n">hub</span><span class="p">:</span> <span class="n">RaspyRFMHub</span> <span class="o">=</span> <span class="n">hass</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">DOMAIN</span><span class="p">][</span><span class="n">entry</span><span class="o">.</span><span class="n">entry_id</span><span class="p">]</span>
    <span class="n">entities</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RaspyRFMSwitch</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@callback</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_entities</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">new_entities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">hub</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">iter_devices_by_type</span><span class="p">(</span><span class="s2">&quot;switch&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">device_id</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">entity</span> <span class="o">=</span> <span class="n">RaspyRFMSwitch</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
            <span class="n">entities</span><span class="p">[</span><span class="n">device</span><span class="o">.</span><span class="n">device_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span>
            <span class="n">new_entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_entities</span><span class="p">:</span>
            <span class="n">async_add_entities</span><span class="p">(</span><span class="n">new_entities</span><span class="p">)</span>

    <span class="n">_ensure_entities</span><span class="p">()</span>

    <span class="nd">@callback</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle_device_update</span><span class="p">(</span><span class="n">device_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">device_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">device_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
            <span class="n">_ensure_entities</span><span class="p">()</span>

    <span class="n">entry</span><span class="o">.</span><span class="n">async_on_unload</span><span class="p">(</span>
        <span class="n">async_dispatcher_connect</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">SIGNAL_DEVICE_REGISTRY_UPDATED</span><span class="p">,</span> <span class="n">handle_device_update</span><span class="p">)</span>
    <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RaspyRFMSwitch</span><span class="p">(</span><span class="n">RaspyRFMEntity</span><span class="p">,</span> <span class="n">SwitchEntity</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Representation of a learned switch.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hub</span><span class="p">:</span> <span class="n">RaspyRFMHub</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">RaspyRFMDeviceEntry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attr_is_on</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_added_to_hass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">async_added_to_hass</span><span class="p">()</span>

        <span class="nd">@callback</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">handle_signal</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">payload</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;on&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_attr_is_on</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">async_write_ha_state</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">payload</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_attr_is_on</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">async_write_ha_state</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span> <span class="o">=</span> <span class="n">async_dispatcher_connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hass</span><span class="p">,</span> <span class="n">SIGNAL_SIGNAL_RECEIVED</span><span class="p">,</span> <span class="n">handle_signal</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_will_remove_from_hass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">async_will_remove_from_hass</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_turn_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;on&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">signal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No ON signal stored for this device&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hub</span><span class="o">.</span><span class="n">async_send_raw</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attr_is_on</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">async_write_ha_state</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_turn_off</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">signal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Device </span><span class="si">%s</span><span class="s2"> has no OFF signal stored; ignoring turn_off request&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">device_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hub</span><span class="o">.</span><span class="n">async_send_raw</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attr_is_on</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">async_write_ha_state</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Binary sensor platform for RaspyRFM.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.components.binary_sensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">BinarySensorEntity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">callback</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.helpers.dispatcher</span><span class="w"> </span><span class="kn">import</span> <span class="n">async_dispatcher_connect</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.const</span><span class="w"> </span><span class="kn">import</span> <span class="n">DOMAIN</span><span class="p">,</span> <span class="n">SIGNAL_DEVICE_REGISTRY_UPDATED</span><span class="p">,</span> <span class="n">SIGNAL_SIGNAL_RECEIVED</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.entity</span><span class="w"> </span><span class="kn">import</span> <span class="n">RaspyRFMEntity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.hub</span><span class="w"> </span><span class="kn">import</span> <span class="n">RaspyRFMHub</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">RaspyRFMDeviceEntry</span>

<span class="n">RESET_TIMEOUT</span> <span class="o">=</span> <span class="mi">5</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_setup_entry</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">async_add_entities</span><span class="p">):</span>
    <span class="n">hub</span><span class="p">:</span> <span class="n">RaspyRFMHub</span> <span class="o">=</span> <span class="n">hass</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">DOMAIN</span><span class="p">][</span><span class="n">entry</span><span class="o">.</span><span class="n">entry_id</span><span class="p">]</span>
    <span class="n">entities</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RaspyRFMBinarySensor</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@callback</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_entities</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">new_entities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">hub</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">iter_devices_by_type</span><span class="p">(</span><span class="s2">&quot;binary_sensor&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">device_id</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">entity</span> <span class="o">=</span> <span class="n">RaspyRFMBinarySensor</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
            <span class="n">entities</span><span class="p">[</span><span class="n">device</span><span class="o">.</span><span class="n">device_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span>
            <span class="n">new_entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_entities</span><span class="p">:</span>
            <span class="n">async_add_entities</span><span class="p">(</span><span class="n">new_entities</span><span class="p">)</span>

    <span class="n">_ensure_entities</span><span class="p">()</span>

    <span class="nd">@callback</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle_device_update</span><span class="p">(</span><span class="n">device_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">device_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">device_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
            <span class="n">_ensure_entities</span><span class="p">()</span>

    <span class="n">entry</span><span class="o">.</span><span class="n">async_on_unload</span><span class="p">(</span>
        <span class="n">async_dispatcher_connect</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">SIGNAL_DEVICE_REGISTRY_UPDATED</span><span class="p">,</span> <span class="n">handle_device_update</span><span class="p">)</span>
    <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RaspyRFMBinarySensor</span><span class="p">(</span><span class="n">RaspyRFMEntity</span><span class="p">,</span> <span class="n">BinarySensorEntity</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Representation of a learned binary sensor.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hub</span><span class="p">:</span> <span class="n">RaspyRFMHub</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">RaspyRFMDeviceEntry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_handle</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimerHandle</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attr_is_on</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_added_to_hass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">async_added_to_hass</span><span class="p">()</span>

        <span class="nd">@callback</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">handle_signal</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">payload</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_attr_is_on</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">async_write_ha_state</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_handle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reset_handle</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_handle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hass</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">call_later</span><span class="p">(</span><span class="n">RESET_TIMEOUT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_state</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span> <span class="o">=</span> <span class="n">async_dispatcher_connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hass</span><span class="p">,</span> <span class="n">SIGNAL_SIGNAL_RECEIVED</span><span class="p">,</span> <span class="n">handle_signal</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_will_remove_from_hass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_handle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_handle</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_handle</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">async_will_remove_from_hass</span><span class="p">()</span>

    <span class="nd">@callback</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_reset_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_handle</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attr_is_on</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">async_write_ha_state</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Light platform for RaspyRFM.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.components.light</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColorMode</span><span class="p">,</span> <span class="n">LightEntity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">callback</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.helpers.dispatcher</span><span class="w"> </span><span class="kn">import</span> <span class="n">async_dispatcher_connect</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.const</span><span class="w"> </span><span class="kn">import</span> <span class="n">DOMAIN</span><span class="p">,</span> <span class="n">SIGNAL_DEVICE_REGISTRY_UPDATED</span><span class="p">,</span> <span class="n">SIGNAL_SIGNAL_RECEIVED</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.entity</span><span class="w"> </span><span class="kn">import</span> <span class="n">RaspyRFMEntity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.hub</span><span class="w"> </span><span class="kn">import</span> <span class="n">RaspyRFMHub</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">RaspyRFMDeviceEntry</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_setup_entry</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">async_add_entities</span><span class="p">):</span>
    <span class="n">hub</span><span class="p">:</span> <span class="n">RaspyRFMHub</span> <span class="o">=</span> <span class="n">hass</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">DOMAIN</span><span class="p">][</span><span class="n">entry</span><span class="o">.</span><span class="n">entry_id</span><span class="p">]</span>
    <span class="n">entities</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RaspyRFMLight</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@callback</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_entities</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">new_entities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">hub</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">iter_devices_by_type</span><span class="p">(</span><span class="s2">&quot;light&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">device_id</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">entity</span> <span class="o">=</span> <span class="n">RaspyRFMLight</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
            <span class="n">entities</span><span class="p">[</span><span class="n">device</span><span class="o">.</span><span class="n">device_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span>
            <span class="n">new_entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_entities</span><span class="p">:</span>
            <span class="n">async_add_entities</span><span class="p">(</span><span class="n">new_entities</span><span class="p">)</span>

    <span class="n">_ensure_entities</span><span class="p">()</span>

    <span class="nd">@callback</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle_device_update</span><span class="p">(</span><span class="n">device_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">device_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">device_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
            <span class="n">_ensure_entities</span><span class="p">()</span>

    <span class="n">entry</span><span class="o">.</span><span class="n">async_on_unload</span><span class="p">(</span>
        <span class="n">async_dispatcher_connect</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">SIGNAL_DEVICE_REGISTRY_UPDATED</span><span class="p">,</span> <span class="n">handle_device_update</span><span class="p">)</span>
    <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RaspyRFMLight</span><span class="p">(</span><span class="n">RaspyRFMEntity</span><span class="p">,</span> <span class="n">LightEntity</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Representation of a dimmable RaspyRFM light.&quot;&quot;&quot;</span>

    <span class="n">_attr_supported_color_modes</span> <span class="o">=</span> <span class="p">{</span><span class="n">ColorMode</span><span class="o">.</span><span class="n">ONOFF</span><span class="p">}</span>
    <span class="n">_attr_color_mode</span> <span class="o">=</span> <span class="n">ColorMode</span><span class="o">.</span><span class="n">ONOFF</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hub</span><span class="p">:</span> <span class="n">RaspyRFMHub</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">RaspyRFMDeviceEntry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attr_is_on</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_added_to_hass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">async_added_to_hass</span><span class="p">()</span>

        <span class="nd">@callback</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">handle_signal</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">payload</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;on&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_attr_is_on</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">payload</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_attr_is_on</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">payload</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bright&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_attr_is_on</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">payload</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dim&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;off&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">signals</span><span class="p">:</span>
                <span class="c1"># Devices without an explicit OFF signal often dim to turn off.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_attr_is_on</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">async_write_ha_state</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span> <span class="o">=</span> <span class="n">async_dispatcher_connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hass</span><span class="p">,</span> <span class="n">SIGNAL_SIGNAL_RECEIVED</span><span class="p">,</span> <span class="n">handle_signal</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_will_remove_from_hass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">async_will_remove_from_hass</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">extra_state_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;available_signals&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_turn_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;on&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bright&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No ON or BRIGHT signal stored for this device&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hub</span><span class="o">.</span><span class="n">async_send_raw</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attr_is_on</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">async_write_ha_state</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_turn_off</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dim&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No OFF or DIM signal stored for this device&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hub</span><span class="o">.</span><span class="n">async_send_raw</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attr_is_on</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">async_write_ha_state</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Button platform for RaspyRFM.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.components.button</span><span class="w"> </span><span class="kn">import</span> <span class="n">ButtonEntity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">callback</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.helpers.dispatcher</span><span class="w"> </span><span class="kn">import</span> <span class="n">async_dispatcher_connect</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">dt</span> <span class="k">as</span> <span class="n">dt_util</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.const</span><span class="w"> </span><span class="kn">import</span> <span class="n">DOMAIN</span><span class="p">,</span> <span class="n">SIGNAL_DEVICE_REGISTRY_UPDATED</span><span class="p">,</span> <span class="n">SIGNAL_SIGNAL_RECEIVED</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.entity</span><span class="w"> </span><span class="kn">import</span> <span class="n">RaspyRFMEntity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.hub</span><span class="w"> </span><span class="kn">import</span> <span class="n">RaspyRFMHub</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">RaspyRFMDeviceEntry</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_setup_entry</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">async_add_entities</span><span class="p">):</span>
    <span class="n">hub</span><span class="p">:</span> <span class="n">RaspyRFMHub</span> <span class="o">=</span> <span class="n">hass</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">DOMAIN</span><span class="p">][</span><span class="n">entry</span><span class="o">.</span><span class="n">entry_id</span><span class="p">]</span>
    <span class="n">entities</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RaspyRFMButton</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@callback</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_entities</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">new_entities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">hub</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">iter_devices_by_type</span><span class="p">(</span><span class="s2">&quot;button&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">device</span><span class="o">.</span><span class="n">device_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">entity</span> <span class="o">=</span> <span class="n">RaspyRFMButton</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
                <span class="n">entities</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span>
                <span class="n">new_entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_entities</span><span class="p">:</span>
            <span class="n">async_add_entities</span><span class="p">(</span><span class="n">new_entities</span><span class="p">)</span>

    <span class="n">_ensure_entities</span><span class="p">()</span>

    <span class="nd">@callback</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle_device_update</span><span class="p">(</span><span class="n">device_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">device_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_ensure_entities</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">hub</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">get_device</span><span class="p">(</span><span class="n">device_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_ensure_entities</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">stale_keys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">key</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">device_id</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">device</span><span class="o">.</span><span class="n">signals</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">stale_keys</span><span class="p">:</span>
            <span class="n">entity</span> <span class="o">=</span> <span class="n">entities</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">hass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">entity</span><span class="o">.</span><span class="n">hass</span><span class="o">.</span><span class="n">async_create_task</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">async_remove</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">device</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">device_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
                <span class="n">_ensure_entities</span><span class="p">()</span>
                <span class="k">return</span>
        <span class="c1"># Existing entities will refresh their state on next dispatcher tick.</span>

    <span class="n">entry</span><span class="o">.</span><span class="n">async_on_unload</span><span class="p">(</span>
        <span class="n">async_dispatcher_connect</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">SIGNAL_DEVICE_REGISTRY_UPDATED</span><span class="p">,</span> <span class="n">handle_device_update</span><span class="p">)</span>
    <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RaspyRFMButton</span><span class="p">(</span><span class="n">RaspyRFMEntity</span><span class="p">,</span> <span class="n">ButtonEntity</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Representation of a RaspyRFM button action.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hub</span><span class="p">:</span> <span class="n">RaspyRFMHub</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">RaspyRFMDeviceEntry</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_action</span> <span class="o">=</span> <span class="n">action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_triggered</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">unique_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">unique_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_action</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_added_to_hass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">async_added_to_hass</span><span class="p">()</span>

        <span class="nd">@callback</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">handle_signal</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">payload</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_action</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_last_triggered</span> <span class="o">=</span> <span class="n">dt_util</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">async_write_ha_state</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span> <span class="o">=</span> <span class="n">async_dispatcher_connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hass</span><span class="p">,</span> <span class="n">SIGNAL_SIGNAL_RECEIVED</span><span class="p">,</span> <span class="n">handle_signal</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_will_remove_from_hass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">async_will_remove_from_hass</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">extra_state_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_triggered</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;last_triggered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_triggered</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">attrs</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_press</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_action</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No signal stored for action </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_action</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hub</span><span class="o">.</span><span class="n">async_send_raw</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_triggered</span> <span class="o">=</span> <span class="n">dt_util</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">async_write_ha_state</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Sensor platform for universal RaspyRFM devices.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.components.sensor</span><span class="w"> </span><span class="kn">import</span> <span class="n">SensorEntity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">callback</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.helpers.dispatcher</span><span class="w"> </span><span class="kn">import</span> <span class="n">async_dispatcher_connect</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.const</span><span class="w"> </span><span class="kn">import</span> <span class="n">DOMAIN</span><span class="p">,</span> <span class="n">SIGNAL_DEVICE_REGISTRY_UPDATED</span><span class="p">,</span> <span class="n">SIGNAL_SIGNAL_RECEIVED</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.entity</span><span class="w"> </span><span class="kn">import</span> <span class="n">RaspyRFMEntity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.hub</span><span class="w"> </span><span class="kn">import</span> <span class="n">RaspyRFMHub</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">RaspyRFMDeviceEntry</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_setup_entry</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">async_add_entities</span><span class="p">):</span>
    <span class="n">hub</span><span class="p">:</span> <span class="n">RaspyRFMHub</span> <span class="o">=</span> <span class="n">hass</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">DOMAIN</span><span class="p">][</span><span class="n">entry</span><span class="o">.</span><span class="n">entry_id</span><span class="p">]</span>
    <span class="n">entities</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RaspyRFMUniversalSensor</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@callback</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_entities</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">new_entities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">hub</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">iter_devices_by_type</span><span class="p">(</span><span class="s2">&quot;universal&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">device_id</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">entity</span> <span class="o">=</span> <span class="n">RaspyRFMUniversalSensor</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
            <span class="n">entities</span><span class="p">[</span><span class="n">device</span><span class="o">.</span><span class="n">device_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span>
            <span class="n">new_entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_entities</span><span class="p">:</span>
            <span class="n">async_add_entities</span><span class="p">(</span><span class="n">new_entities</span><span class="p">)</span>

    <span class="n">_ensure_entities</span><span class="p">()</span>

    <span class="nd">@callback</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle_device_update</span><span class="p">(</span><span class="n">device_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">device_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">device_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
            <span class="n">_ensure_entities</span><span class="p">()</span>

    <span class="n">entry</span><span class="o">.</span><span class="n">async_on_unload</span><span class="p">(</span>
        <span class="n">async_dispatcher_connect</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">SIGNAL_DEVICE_REGISTRY_UPDATED</span><span class="p">,</span> <span class="n">handle_device_update</span><span class="p">)</span>
    <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RaspyRFMUniversalSensor</span><span class="p">(</span><span class="n">RaspyRFMEntity</span><span class="p">,</span> <span class="n">SensorEntity</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A best-effort entity for devices without a dedicated platform.&quot;&quot;&quot;</span>

    <span class="n">_attr_icon</span> <span class="o">=</span> <span class="s2">&quot;mdi:radio-tower&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hub</span><span class="p">:</span> <span class="n">RaspyRFMHub</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">RaspyRFMDeviceEntry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">hub</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attr_native_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_added_to_hass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">async_added_to_hass</span><span class="p">()</span>

        <span class="nd">@callback</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">handle_signal</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">action</span><span class="p">,</span> <span class="n">stored_payload</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">payload</span> <span class="o">==</span> <span class="n">stored_payload</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_attr_native_value</span> <span class="o">=</span> <span class="n">action</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">async_write_ha_state</span><span class="p">()</span>
                    <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span> <span class="o">=</span> <span class="n">async_dispatcher_connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hass</span><span class="p">,</span> <span class="n">SIGNAL_SIGNAL_RECEIVED</span><span class="p">,</span> <span class="n">handle_signal</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_will_remove_from_hass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal_unsub</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">async_will_remove_from_hass</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">extra_state_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;available_actions&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="p">}</span>
</pre></div>
</div>
</section>
<section id="websocket-api-surface">
<h2>Websocket API surface<a class="headerlink" href="#websocket-api-surface" title="Link to this heading">¶</a></h2>
<p>The integration exposes a websocket namespace under <code class="docutils literal notranslate"><span class="pre">raspyrfm/</span></code>.  The
commands cover the full lifecycle: starting and stopping capture, listing
signals, creating or deleting devices, triggering stored actions, and
maintaining the optional signal mapping metadata.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Websocket commands exposed by the RaspyRFM integration.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Set</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">voluptuous</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">vol</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">HomeAssistant</span><span class="p">,</span> <span class="n">callback</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">config_validation</span> <span class="k">as</span> <span class="n">cv</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.helpers.dispatcher</span><span class="w"> </span><span class="kn">import</span> <span class="n">async_dispatcher_connect</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.components</span><span class="w"> </span><span class="kn">import</span> <span class="n">websocket_api</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.const</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">DOMAIN</span><span class="p">,</span>
    <span class="n">MAPPING_CATEGORIES</span><span class="p">,</span>
    <span class="n">SIGNAL_LEARNING_STATE</span><span class="p">,</span>
    <span class="n">SIGNAL_SIGNAL_RECEIVED</span><span class="p">,</span>
    <span class="n">WS_TYPE_DEVICE_CREATE</span><span class="p">,</span>
    <span class="n">WS_TYPE_DEVICE_DELETE</span><span class="p">,</span>
    <span class="n">WS_TYPE_DEVICE_LIST</span><span class="p">,</span>
    <span class="n">WS_TYPE_DEVICE_RELOAD</span><span class="p">,</span>
    <span class="n">WS_TYPE_DEVICE_SEND</span><span class="p">,</span>
    <span class="n">WS_TYPE_LEARNING_START</span><span class="p">,</span>
    <span class="n">WS_TYPE_LEARNING_STATUS</span><span class="p">,</span>
    <span class="n">WS_TYPE_LEARNING_STOP</span><span class="p">,</span>
    <span class="n">WS_TYPE_LEARNING_SUBSCRIBE</span><span class="p">,</span>
    <span class="n">WS_TYPE_SIGNAL_MAP_DELETE</span><span class="p">,</span>
    <span class="n">WS_TYPE_SIGNAL_MAP_LIST</span><span class="p">,</span>
    <span class="n">WS_TYPE_SIGNAL_MAP_UPDATE</span><span class="p">,</span>
    <span class="n">WS_TYPE_SIGNALS_LIST</span><span class="p">,</span>
    <span class="n">WS_TYPE_SIGNALS_SUBSCRIBE</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.hub</span><span class="w"> </span><span class="kn">import</span> <span class="n">RaspyRFMHub</span>

<span class="n">_LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">HANDLERS_REGISTERED</span> <span class="o">=</span> <span class="s2">&quot;_raspyrfm_ws_handlers&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">async_register_websocket_handlers</span><span class="p">(</span><span class="n">hass</span><span class="p">:</span> <span class="n">HomeAssistant</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Register websocket commands.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">hass</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">HANDLERS_REGISTERED</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="n">websocket_api</span><span class="o">.</span><span class="n">async_register_command</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">handle_learning_start</span><span class="p">)</span>
    <span class="n">websocket_api</span><span class="o">.</span><span class="n">async_register_command</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">handle_learning_stop</span><span class="p">)</span>
    <span class="n">websocket_api</span><span class="o">.</span><span class="n">async_register_command</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">handle_learning_status</span><span class="p">)</span>
    <span class="n">websocket_api</span><span class="o">.</span><span class="n">async_register_command</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">handle_learning_subscribe</span><span class="p">)</span>
    <span class="n">websocket_api</span><span class="o">.</span><span class="n">async_register_command</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">handle_signals_list</span><span class="p">)</span>
    <span class="n">websocket_api</span><span class="o">.</span><span class="n">async_register_command</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">handle_signals_subscribe</span><span class="p">)</span>
    <span class="n">websocket_api</span><span class="o">.</span><span class="n">async_register_command</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">handle_device_create</span><span class="p">)</span>
    <span class="n">websocket_api</span><span class="o">.</span><span class="n">async_register_command</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">handle_device_delete</span><span class="p">)</span>
    <span class="n">websocket_api</span><span class="o">.</span><span class="n">async_register_command</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">handle_device_list</span><span class="p">)</span>
    <span class="n">websocket_api</span><span class="o">.</span><span class="n">async_register_command</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">handle_device_reload</span><span class="p">)</span>
    <span class="n">websocket_api</span><span class="o">.</span><span class="n">async_register_command</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">handle_device_send_action</span><span class="p">)</span>
    <span class="n">websocket_api</span><span class="o">.</span><span class="n">async_register_command</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">handle_signal_map_list</span><span class="p">)</span>
    <span class="n">websocket_api</span><span class="o">.</span><span class="n">async_register_command</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">handle_signal_map_update</span><span class="p">)</span>
    <span class="n">websocket_api</span><span class="o">.</span><span class="n">async_register_command</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">handle_signal_map_delete</span><span class="p">)</span>

    <span class="n">hass</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">HANDLERS_REGISTERED</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_hub</span><span class="p">(</span><span class="n">hass</span><span class="p">:</span> <span class="n">HomeAssistant</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">RaspyRFMHub</span><span class="p">:</span>
    <span class="n">entry_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entry_id&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">entry_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># fallback to first entry</span>
        <span class="k">if</span> <span class="n">DOMAIN</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hass</span><span class="o">.</span><span class="n">data</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">hass</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">DOMAIN</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">websocket_api</span><span class="o">.</span><span class="n">HomeAssistantWebSocketError</span><span class="p">(</span><span class="s2">&quot;No RaspyRFM entries configured&quot;</span><span class="p">)</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">hass</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">DOMAIN</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">websocket_api</span><span class="o">.</span><span class="n">HomeAssistantWebSocketError</span><span class="p">(</span><span class="s2">&quot;No RaspyRFM entries configured&quot;</span><span class="p">)</span>
        <span class="n">entry_id</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">hub</span> <span class="o">=</span> <span class="n">hass</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">DOMAIN</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">entry_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hub</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">websocket_api</span><span class="o">.</span><span class="n">HomeAssistantWebSocketError</span><span class="p">(</span><span class="s2">&quot;Unknown RaspyRFM entry&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hub</span>


<span class="nd">@websocket_api</span><span class="o">.</span><span class="n">websocket_command</span><span class="p">({</span><span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">):</span> <span class="n">WS_TYPE_LEARNING_START</span><span class="p">,</span> <span class="n">vol</span><span class="o">.</span><span class="n">Optional</span><span class="p">(</span><span class="s2">&quot;entry_id&quot;</span><span class="p">):</span> <span class="nb">str</span><span class="p">})</span>
<span class="nd">@websocket_api</span><span class="o">.</span><span class="n">async_response</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_learning_start</span><span class="p">(</span><span class="n">hass</span><span class="p">:</span> <span class="n">HomeAssistant</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">websocket_api</span><span class="o">.</span><span class="n">ActiveConnection</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Start capturing signals.&quot;&quot;&quot;</span>

    <span class="n">hub</span> <span class="o">=</span> <span class="n">_get_hub</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">hub</span><span class="o">.</span><span class="n">async_start_learning</span><span class="p">()</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">send_result</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>


<span class="nd">@websocket_api</span><span class="o">.</span><span class="n">websocket_command</span><span class="p">({</span><span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">):</span> <span class="n">WS_TYPE_LEARNING_STOP</span><span class="p">,</span> <span class="n">vol</span><span class="o">.</span><span class="n">Optional</span><span class="p">(</span><span class="s2">&quot;entry_id&quot;</span><span class="p">):</span> <span class="nb">str</span><span class="p">})</span>
<span class="nd">@websocket_api</span><span class="o">.</span><span class="n">async_response</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_learning_stop</span><span class="p">(</span><span class="n">hass</span><span class="p">:</span> <span class="n">HomeAssistant</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">websocket_api</span><span class="o">.</span><span class="n">ActiveConnection</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stop capturing signals.&quot;&quot;&quot;</span>

    <span class="n">hub</span> <span class="o">=</span> <span class="n">_get_hub</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">hub</span><span class="o">.</span><span class="n">async_stop_learning</span><span class="p">()</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">send_result</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>


<span class="nd">@websocket_api</span><span class="o">.</span><span class="n">websocket_command</span><span class="p">({</span><span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">):</span> <span class="n">WS_TYPE_LEARNING_STATUS</span><span class="p">,</span> <span class="n">vol</span><span class="o">.</span><span class="n">Optional</span><span class="p">(</span><span class="s2">&quot;entry_id&quot;</span><span class="p">):</span> <span class="nb">str</span><span class="p">})</span>
<span class="nd">@websocket_api</span><span class="o">.</span><span class="n">async_response</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_learning_status</span><span class="p">(</span><span class="n">hass</span><span class="p">:</span> <span class="n">HomeAssistant</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">websocket_api</span><span class="o">.</span><span class="n">ActiveConnection</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the current learning state.&quot;&quot;&quot;</span>

    <span class="n">hub</span> <span class="o">=</span> <span class="n">_get_hub</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">send_result</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="n">hub</span><span class="o">.</span><span class="n">learn_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">})</span>


<span class="nd">@websocket_api</span><span class="o">.</span><span class="n">websocket_command</span><span class="p">({</span><span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">):</span> <span class="n">WS_TYPE_LEARNING_SUBSCRIBE</span><span class="p">,</span> <span class="n">vol</span><span class="o">.</span><span class="n">Optional</span><span class="p">(</span><span class="s2">&quot;entry_id&quot;</span><span class="p">):</span> <span class="nb">str</span><span class="p">})</span>
<span class="nd">@callback</span>
<span class="k">def</span><span class="w"> </span><span class="nf">handle_learning_subscribe</span><span class="p">(</span><span class="n">hass</span><span class="p">:</span> <span class="n">HomeAssistant</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">websocket_api</span><span class="o">.</span><span class="n">ActiveConnection</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Subscribe to learning state updates.&quot;&quot;&quot;</span>

    <span class="nd">@callback</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">websocket_api</span><span class="o">.</span><span class="n">event_message</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">payload</span><span class="p">))</span>

    <span class="n">connection</span><span class="o">.</span><span class="n">subscriptions</span><span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">async_dispatcher_connect</span><span class="p">(</span>
        <span class="n">hass</span><span class="p">,</span> <span class="n">SIGNAL_LEARNING_STATE</span><span class="p">,</span> <span class="n">forward</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">send_result</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>


<span class="nd">@websocket_api</span><span class="o">.</span><span class="n">websocket_command</span><span class="p">({</span><span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">):</span> <span class="n">WS_TYPE_SIGNALS_LIST</span><span class="p">,</span> <span class="n">vol</span><span class="o">.</span><span class="n">Optional</span><span class="p">(</span><span class="s2">&quot;entry_id&quot;</span><span class="p">):</span> <span class="nb">str</span><span class="p">})</span>
<span class="nd">@websocket_api</span><span class="o">.</span><span class="n">async_response</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_signals_list</span><span class="p">(</span><span class="n">hass</span><span class="p">:</span> <span class="n">HomeAssistant</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">websocket_api</span><span class="o">.</span><span class="n">ActiveConnection</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a list of currently captured signals.&quot;&quot;&quot;</span>

    <span class="n">hub</span> <span class="o">=</span> <span class="n">_get_hub</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    <span class="n">signals</span> <span class="o">=</span> <span class="k">await</span> <span class="n">hub</span><span class="o">.</span><span class="n">learn_manager</span><span class="o">.</span><span class="n">async_list_signals</span><span class="p">()</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">send_result</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;signals&quot;</span><span class="p">:</span> <span class="n">signals</span><span class="p">})</span>


<span class="nd">@websocket_api</span><span class="o">.</span><span class="n">websocket_command</span><span class="p">({</span><span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">):</span> <span class="n">WS_TYPE_SIGNALS_SUBSCRIBE</span><span class="p">,</span> <span class="n">vol</span><span class="o">.</span><span class="n">Optional</span><span class="p">(</span><span class="s2">&quot;entry_id&quot;</span><span class="p">):</span> <span class="nb">str</span><span class="p">})</span>
<span class="nd">@callback</span>
<span class="k">def</span><span class="w"> </span><span class="nf">handle_signals_subscribe</span><span class="p">(</span><span class="n">hass</span><span class="p">:</span> <span class="n">HomeAssistant</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">websocket_api</span><span class="o">.</span><span class="n">ActiveConnection</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Subscribe to incoming signals.&quot;&quot;&quot;</span>

    <span class="nd">@callback</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">websocket_api</span><span class="o">.</span><span class="n">event_message</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">payload</span><span class="p">))</span>

    <span class="n">connection</span><span class="o">.</span><span class="n">subscriptions</span><span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">async_dispatcher_connect</span><span class="p">(</span>
        <span class="n">hass</span><span class="p">,</span> <span class="n">SIGNAL_SIGNAL_RECEIVED</span><span class="p">,</span> <span class="n">forward</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">send_result</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>


<span class="n">SUPPORTED_DEVICE_TYPES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;switch&quot;</span><span class="p">,</span> <span class="s2">&quot;binary_sensor&quot;</span><span class="p">,</span> <span class="s2">&quot;light&quot;</span><span class="p">,</span> <span class="s2">&quot;button&quot;</span><span class="p">,</span> <span class="s2">&quot;universal&quot;</span><span class="p">]</span>


<span class="n">_DEVICE_CREATE_SCHEMA</span> <span class="o">=</span> <span class="n">websocket_api</span><span class="o">.</span><span class="n">BASE_COMMAND_MESSAGE_SCHEMA</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">):</span> <span class="n">WS_TYPE_DEVICE_CREATE</span><span class="p">,</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">):</span> <span class="n">cv</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="s2">&quot;device_type&quot;</span><span class="p">):</span> <span class="n">vol</span><span class="o">.</span><span class="n">In</span><span class="p">(</span><span class="n">SUPPORTED_DEVICE_TYPES</span><span class="p">),</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="s2">&quot;signals&quot;</span><span class="p">):</span> <span class="p">{</span><span class="n">cv</span><span class="o">.</span><span class="n">string</span><span class="p">:</span> <span class="n">cv</span><span class="o">.</span><span class="n">string</span><span class="p">},</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">Optional</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">):</span> <span class="p">{</span><span class="n">cv</span><span class="o">.</span><span class="n">string</span><span class="p">:</span> <span class="n">cv</span><span class="o">.</span><span class="n">Any</span><span class="p">()},</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">Optional</span><span class="p">(</span><span class="s2">&quot;entry_id&quot;</span><span class="p">):</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>


<span class="nd">@websocket_api</span><span class="o">.</span><span class="n">websocket_command</span><span class="p">(</span><span class="n">_DEVICE_CREATE_SCHEMA</span><span class="p">)</span>
<span class="nd">@websocket_api</span><span class="o">.</span><span class="n">async_response</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_device_create</span><span class="p">(</span><span class="n">hass</span><span class="p">:</span> <span class="n">HomeAssistant</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">websocket_api</span><span class="o">.</span><span class="n">ActiveConnection</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a device from captured signals.&quot;&quot;&quot;</span>

    <span class="n">hub</span> <span class="o">=</span> <span class="n">_get_hub</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    <span class="n">_validate_device_payload</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;device_type&quot;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;signals&quot;</span><span class="p">])</span>
    <span class="n">device</span> <span class="o">=</span> <span class="k">await</span> <span class="n">hub</span><span class="o">.</span><span class="n">async_create_device</span><span class="p">(</span>
        <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;device_type&quot;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;signals&quot;</span><span class="p">],</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">send_result</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="n">device</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()})</span>


<span class="nd">@websocket_api</span><span class="o">.</span><span class="n">websocket_command</span><span class="p">({</span>
    <span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">):</span> <span class="n">WS_TYPE_DEVICE_DELETE</span><span class="p">,</span>
    <span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="s2">&quot;device_id&quot;</span><span class="p">):</span> <span class="n">cv</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
    <span class="n">vol</span><span class="o">.</span><span class="n">Optional</span><span class="p">(</span><span class="s2">&quot;entry_id&quot;</span><span class="p">):</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">})</span>
<span class="nd">@websocket_api</span><span class="o">.</span><span class="n">async_response</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_device_delete</span><span class="p">(</span><span class="n">hass</span><span class="p">:</span> <span class="n">HomeAssistant</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">websocket_api</span><span class="o">.</span><span class="n">ActiveConnection</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete a stored device.&quot;&quot;&quot;</span>

    <span class="n">hub</span> <span class="o">=</span> <span class="n">_get_hub</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">hub</span><span class="o">.</span><span class="n">async_remove_device</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;device_id&quot;</span><span class="p">])</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">send_result</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="p">{})</span>


<span class="nd">@websocket_api</span><span class="o">.</span><span class="n">websocket_command</span><span class="p">({</span><span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">):</span> <span class="n">WS_TYPE_DEVICE_LIST</span><span class="p">,</span> <span class="n">vol</span><span class="o">.</span><span class="n">Optional</span><span class="p">(</span><span class="s2">&quot;entry_id&quot;</span><span class="p">):</span> <span class="nb">str</span><span class="p">})</span>
<span class="nd">@websocket_api</span><span class="o">.</span><span class="n">async_response</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_device_list</span><span class="p">(</span><span class="n">hass</span><span class="p">:</span> <span class="n">HomeAssistant</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">websocket_api</span><span class="o">.</span><span class="n">ActiveConnection</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the list of stored devices.&quot;&quot;&quot;</span>

    <span class="n">hub</span> <span class="o">=</span> <span class="n">_get_hub</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="p">[</span><span class="n">device</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">hub</span><span class="o">.</span><span class="n">iter_devices</span><span class="p">()]</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">send_result</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;devices&quot;</span><span class="p">:</span> <span class="n">devices</span><span class="p">})</span>


<span class="nd">@websocket_api</span><span class="o">.</span><span class="n">websocket_command</span><span class="p">({</span><span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">):</span> <span class="n">WS_TYPE_DEVICE_RELOAD</span><span class="p">,</span> <span class="n">vol</span><span class="o">.</span><span class="n">Optional</span><span class="p">(</span><span class="s2">&quot;entry_id&quot;</span><span class="p">):</span> <span class="nb">str</span><span class="p">})</span>
<span class="nd">@websocket_api</span><span class="o">.</span><span class="n">async_response</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_device_reload</span><span class="p">(</span><span class="n">hass</span><span class="p">:</span> <span class="n">HomeAssistant</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">websocket_api</span><span class="o">.</span><span class="n">ActiveConnection</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reload devices from persistent storage.&quot;&quot;&quot;</span>

    <span class="n">hub</span> <span class="o">=</span> <span class="n">_get_hub</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">hub</span><span class="o">.</span><span class="n">async_reload_devices</span><span class="p">()</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">send_result</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="p">{})</span>


<span class="nd">@websocket_api</span><span class="o">.</span><span class="n">websocket_command</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">):</span> <span class="n">WS_TYPE_DEVICE_SEND</span><span class="p">,</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="s2">&quot;device_id&quot;</span><span class="p">):</span> <span class="n">cv</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">):</span> <span class="n">cv</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">Optional</span><span class="p">(</span><span class="s2">&quot;entry_id&quot;</span><span class="p">):</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="nd">@websocket_api</span><span class="o">.</span><span class="n">async_response</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_device_send_action</span><span class="p">(</span>
    <span class="n">hass</span><span class="p">:</span> <span class="n">HomeAssistant</span><span class="p">,</span>
    <span class="n">connection</span><span class="p">:</span> <span class="n">websocket_api</span><span class="o">.</span><span class="n">ActiveConnection</span><span class="p">,</span>
    <span class="n">msg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Trigger a stored signal for a RaspyRFM device.&quot;&quot;&quot;</span>

    <span class="n">hub</span> <span class="o">=</span> <span class="n">_get_hub</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">hub</span><span class="o">.</span><span class="n">async_send_device_action</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;device_id&quot;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">websocket_api</span><span class="o">.</span><span class="n">HomeAssistantWebSocketError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">send_result</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="p">{})</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_validate_device_payload</span><span class="p">(</span><span class="n">device_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">signals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure the provided payload mapping matches the expected schema.&quot;&quot;&quot;</span>

    <span class="n">required</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">optional</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">device_type</span> <span class="o">==</span> <span class="s2">&quot;switch&quot;</span><span class="p">:</span>
        <span class="n">required</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;on&quot;</span><span class="p">:</span> <span class="s2">&quot;ON payload&quot;</span><span class="p">,</span> <span class="s2">&quot;off&quot;</span><span class="p">:</span> <span class="s2">&quot;OFF payload&quot;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">device_type</span> <span class="o">==</span> <span class="s2">&quot;binary_sensor&quot;</span><span class="p">:</span>
        <span class="n">required</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;trigger&quot;</span><span class="p">:</span> <span class="s2">&quot;Trigger payload&quot;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">device_type</span> <span class="o">==</span> <span class="s2">&quot;light&quot;</span><span class="p">:</span>
        <span class="n">required</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;on&quot;</span><span class="p">:</span> <span class="s2">&quot;ON payload&quot;</span><span class="p">}</span>
        <span class="n">optional</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;off&quot;</span><span class="p">,</span> <span class="s2">&quot;bright&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">device_type</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;button&quot;</span><span class="p">,</span> <span class="s2">&quot;universal&quot;</span><span class="p">}:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">signals</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">websocket_api</span><span class="o">.</span><span class="n">HomeAssistantWebSocketError</span><span class="p">(</span>
                <span class="s2">&quot;Provide at least one signal mapping&quot;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">websocket_api</span><span class="o">.</span><span class="n">HomeAssistantWebSocketError</span><span class="p">(</span><span class="s2">&quot;Unsupported device type&quot;</span><span class="p">)</span>

    <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">required</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">signals</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">signals</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">websocket_api</span><span class="o">.</span><span class="n">HomeAssistantWebSocketError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Missing </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">device_type</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">device_type</span> <span class="o">==</span> <span class="s2">&quot;light&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="n">websocket_api</span><span class="o">.</span><span class="n">HomeAssistantWebSocketError</span><span class="p">(</span>
            <span class="s2">&quot;Provide either an OFF or DIM payload for light devices&quot;</span>
        <span class="p">)</span>

    <span class="n">unexpected</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">key</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">signals</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">required</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">optional</span> <span class="ow">and</span> <span class="n">device_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;button&quot;</span><span class="p">,</span> <span class="s2">&quot;universal&quot;</span><span class="p">}</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">unexpected</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">websocket_api</span><span class="o">.</span><span class="n">HomeAssistantWebSocketError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unexpected signals for </span><span class="si">{</span><span class="n">device_type</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unexpected</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>


<span class="nd">@websocket_api</span><span class="o">.</span><span class="n">websocket_command</span><span class="p">({</span><span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">):</span> <span class="n">WS_TYPE_SIGNAL_MAP_LIST</span><span class="p">,</span> <span class="n">vol</span><span class="o">.</span><span class="n">Optional</span><span class="p">(</span><span class="s2">&quot;entry_id&quot;</span><span class="p">):</span> <span class="nb">str</span><span class="p">})</span>
<span class="nd">@websocket_api</span><span class="o">.</span><span class="n">async_response</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_signal_map_list</span><span class="p">(</span><span class="n">hass</span><span class="p">:</span> <span class="n">HomeAssistant</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">websocket_api</span><span class="o">.</span><span class="n">ActiveConnection</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the stored signal mapping metadata.&quot;&quot;&quot;</span>

    <span class="n">hub</span> <span class="o">=</span> <span class="n">_get_hub</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    <span class="n">mappings</span> <span class="o">=</span> <span class="k">await</span> <span class="n">hub</span><span class="o">.</span><span class="n">async_list_signal_mappings</span><span class="p">()</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">send_result</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;mappings&quot;</span><span class="p">:</span> <span class="n">mappings</span><span class="p">})</span>


<span class="n">_SIGNAL_MAP_UPDATE_SCHEMA</span> <span class="o">=</span> <span class="n">websocket_api</span><span class="o">.</span><span class="n">BASE_COMMAND_MESSAGE_SCHEMA</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">):</span> <span class="n">WS_TYPE_SIGNAL_MAP_UPDATE</span><span class="p">,</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">):</span> <span class="n">cv</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">):</span> <span class="n">vol</span><span class="o">.</span><span class="n">In</span><span class="p">(</span><span class="n">MAPPING_CATEGORIES</span><span class="p">),</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">Required</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">):</span> <span class="n">cv</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">Optional</span><span class="p">(</span><span class="s2">&quot;linked_devices&quot;</span><span class="p">):</span> <span class="p">[</span><span class="n">cv</span><span class="o">.</span><span class="n">string</span><span class="p">],</span>
        <span class="n">vol</span><span class="o">.</span><span class="n">Optional</span><span class="p">(</span><span class="s2">&quot;entry_id&quot;</span><span class="p">):</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>


<span class="nd">@websocket_api</span><span class="o">.</span><span class="n">websocket_command</span><span class="p">(</span><span class="n">_SIGNAL_MAP_UPDATE_SCHEMA</span><span class="p">)</span>
<span class="nd">@websocket_api</span><span class="o">.</span><span class="n">async_response</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_signal_map_update</span><span class="p">(</span><span class="n">hass</span><span class="p">:</span> <span class="n">HomeAssistant</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">websocket_api</span><span class="o">.</span><span class="n">ActiveConnection</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store mapping information for a payload.&quot;&quot;&quot;</span>

    <span class="n">hub</span> <span class="o">=</span> <span class="n">_get_hub</span><span class="p">(</span><span class="n">hass</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="k">await</span> <span class="n">hub</span><span class="o">.</span><span class="n">async_set_signal_mapping</span><span class="p">(</span>
        <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;payload&quot;</span><span class="p">],</span>
        <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">],</span>
        <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">],</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;linked_devices&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">send_result</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;mapping&quot;</span><span class="p">:</span> <span class="n">mapping</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()})</span>

</pre></div>
</div>
</section>
<section id="panel-registration-and-static-assets">
<h2>Panel registration and static assets<a class="headerlink" href="#panel-registration-and-static-assets" title="Link to this heading">¶</a></h2>
<p>Every config entry registers a static path and serves a custom panel that
is restricted to administrators.  The panel is implemented as a LitElement
module that runs entirely inside the Home Assistant frontend.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Frontend panel registration for RaspyRFM.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">importlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">resources</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Set</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.config_entries</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigEntry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">homeassistant.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">HomeAssistant</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.const</span><span class="w"> </span><span class="kn">import</span> <span class="n">PANEL_ICON</span><span class="p">,</span> <span class="n">PANEL_TITLE</span><span class="p">,</span> <span class="n">PANEL_URL_PATH</span>

<span class="n">STATIC_PATH</span> <span class="o">=</span> <span class="s2">&quot;/raspyrfm_static&quot;</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_register_panel</span><span class="p">(</span><span class="n">hass</span><span class="p">:</span> <span class="n">HomeAssistant</span><span class="p">,</span> <span class="n">entry</span><span class="p">:</span> <span class="n">ConfigEntry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Register the RaspyRFM panel.&quot;&quot;&quot;</span>

    <span class="n">entries</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">hass</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;_raspyrfm_panel_entries&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">entry_id</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">entries</span><span class="p">:</span>
        <span class="n">panel_path</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="n">__package__</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;frontend&quot;</span><span class="p">)</span>
        <span class="n">hass</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">register_static_path</span><span class="p">(</span><span class="n">STATIC_PATH</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">panel_path</span><span class="p">),</span> <span class="n">cache_headers</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">hass</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">frontend</span><span class="o">.</span><span class="n">async_register_panel</span><span class="p">(</span>
            <span class="n">component_name</span><span class="o">=</span><span class="s2">&quot;custom&quot;</span><span class="p">,</span>
            <span class="n">frontend_url_path</span><span class="o">=</span><span class="n">PANEL_URL_PATH</span><span class="p">,</span>
            <span class="n">webcomponent_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">STATIC_PATH</span><span class="si">}</span><span class="s2">/raspyrfm-panel.js&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">PANEL_TITLE</span><span class="p">,</span> <span class="s2">&quot;icon&quot;</span><span class="p">:</span> <span class="n">PANEL_ICON</span><span class="p">},</span>
            <span class="n">require_admin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">entries</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">entry_id</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_unregister_panel</span><span class="p">(</span><span class="n">hass</span><span class="p">:</span> <span class="n">HomeAssistant</span><span class="p">,</span> <span class="n">entry</span><span class="p">:</span> <span class="n">ConfigEntry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unregister panel for a given entry.&quot;&quot;&quot;</span>

    <span class="n">entries</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">hass</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_raspyrfm_panel_entries&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
    <span class="n">entries</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">entry_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">entries</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">hass</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">frontend</span><span class="o">.</span><span class="n">async_remove_panel</span><span class="p">(</span><span class="n">PANEL_URL_PATH</span><span class="p">)</span>
    <span class="n">hass</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">unregister_static_path</span><span class="p">(</span><span class="n">STATIC_PATH</span><span class="p">)</span>
    <span class="n">hass</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_raspyrfm_panel_entries&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="frontend-component">
<h2>Frontend component<a class="headerlink" href="#frontend-component" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">raspyrfm-panel</span></code> web component drives the onboarding experience for
RaspyRFM users.  It exposes learning controls, renders cards summarising
captured payloads, fingerprints signals against the Python library to
suggest device types, provides a flexible creation form, and lets users map
payloads to semantic categories with optional device links.  The component
relies exclusively on the websocket commands described above, so no
additional backend endpoints are required.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">LitElement</span><span class="p">,</span><span class="w"> </span><span class="nx">html</span><span class="p">,</span><span class="w"> </span><span class="nx">css</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">window</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">MAX_SIGNAL_HISTORY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">200</span><span class="p">;</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">RaspyRFMPanel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">LitElement</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">get</span><span class="w"> </span><span class="nx">properties</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">hass</span><span class="o">:</span><span class="w"> </span><span class="p">{},</span>
<span class="w">      </span><span class="nx">learning</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">Boolean</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">signals</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">devices</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">signalMappings</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">formType</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">formName</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">formSignals</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">formActions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">formCustomAction</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">successMessage</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">infoMessage</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">get</span><span class="w"> </span><span class="nx">styles</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">css</span><span class="sb">`</span>
<span class="sb">      :host {</span>
<span class="sb">        display: block;</span>
<span class="sb">        min-height: 100%;</span>
<span class="sb">        padding: 24px;</span>
<span class="sb">        background: linear-gradient(135deg, var(--primary-background-color), rgba(0, 0, 0, 0))</span>
<span class="sb">          no-repeat;</span>
<span class="sb">        --success-color-fallback: #4caf50;</span>
<span class="sb">        --info-color-fallback: #2196f3;</span>
<span class="sb">      }</span>

<span class="sb">      h2.section-title {</span>
<span class="sb">        font-size: 1.4rem;</span>
<span class="sb">        font-weight: 600;</span>
<span class="sb">        margin: 0 0 12px;</span>
<span class="sb">        display: flex;</span>
<span class="sb">        align-items: center;</span>
<span class="sb">        gap: 8px;</span>
<span class="sb">      }</span>

<span class="sb">      .layout {</span>
<span class="sb">        display: grid;</span>
<span class="sb">        gap: 24px;</span>
<span class="sb">      }</span>

<span class="sb">      .split-columns {</span>
<span class="sb">        display: grid;</span>
<span class="sb">        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));</span>
<span class="sb">        gap: 24px;</span>
<span class="sb">      }</span>

<span class="sb">      .actions {</span>
<span class="sb">        display: flex;</span>
<span class="sb">        flex-wrap: wrap;</span>
<span class="sb">        gap: 12px;</span>
<span class="sb">        margin-bottom: 24px;</span>
<span class="sb">      }</span>

<span class="sb">      ha-card {</span>
<span class="sb">        border-radius: 18px;</span>
<span class="sb">        box-shadow: var(--ha-card-box-shadow, 0 10px 30px rgba(0, 0, 0, 0.12));</span>
<span class="sb">        overflow: hidden;</span>
<span class="sb">      }</span>

<span class="sb">      ha-card .card-content {</span>
<span class="sb">        padding: 20px;</span>
<span class="sb">      }</span>

<span class="sb">      table {</span>
<span class="sb">        width: 100%;</span>
<span class="sb">        border-collapse: collapse;</span>
<span class="sb">      }</span>

<span class="sb">      th,</span>
<span class="sb">      td {</span>
<span class="sb">        padding: 10px;</span>
<span class="sb">        border-bottom: 1px solid var(--divider-color);</span>
<span class="sb">        font-size: 0.95rem;</span>
<span class="sb">      }</span>

<span class="sb">      tbody tr:last-child td {</span>
<span class="sb">        border-bottom: none;</span>
<span class="sb">      }</span>

<span class="sb">      .signal-list {</span>
<span class="sb">        max-height: 320px;</span>
<span class="sb">        overflow-y: auto;</span>
<span class="sb">        display: grid;</span>
<span class="sb">        gap: 12px;</span>
<span class="sb">      }</span>

<span class="sb">      .signal-entry {</span>
<span class="sb">        display: flex;</span>
<span class="sb">        justify-content: space-between;</span>
<span class="sb">        align-items: center;</span>
<span class="sb">        padding: 14px;</span>
<span class="sb">        border-radius: 12px;</span>
<span class="sb">        background: rgba(0, 0, 0, 0.04);</span>
<span class="sb">      }</span>

<span class="sb">      .meta-block {</span>
<span class="sb">        display: flex;</span>
<span class="sb">        flex-direction: column;</span>
<span class="sb">        gap: 4px;</span>
<span class="sb">      }</span>

<span class="sb">      .signal-meta {</span>
<span class="sb">        font-size: 12px;</span>
<span class="sb">        color: var(--secondary-text-color);</span>
<span class="sb">      }</span>

<span class="sb">      .form-grid {</span>
<span class="sb">        display: grid;</span>
<span class="sb">        gap: 16px;</span>
<span class="sb">      }</span>

<span class="sb">      .form-row {</span>
<span class="sb">        display: flex;</span>
<span class="sb">        gap: 12px;</span>
<span class="sb">        align-items: center;</span>
<span class="sb">        flex-wrap: wrap;</span>
<span class="sb">      }</span>

<span class="sb">      .pill {</span>
<span class="sb">        padding: 2px 8px;</span>
<span class="sb">        border-radius: 12px;</span>
<span class="sb">        background-color: var(--accent-color);</span>
<span class="sb">        color: var(--text-primary-color);</span>
<span class="sb">        font-size: 12px;</span>
<span class="sb">      }</span>

<span class="sb">      .chip {</span>
<span class="sb">        display: inline-flex;</span>
<span class="sb">        align-items: center;</span>
<span class="sb">        gap: 6px;</span>
<span class="sb">        padding: 4px 10px;</span>
<span class="sb">        border-radius: 14px;</span>
<span class="sb">        background: rgba(0, 0, 0, 0.08);</span>
<span class="sb">        font-size: 0.75rem;</span>
<span class="sb">        font-weight: 600;</span>
<span class="sb">        text-transform: uppercase;</span>
<span class="sb">        letter-spacing: 0.04em;</span>
<span class="sb">      }</span>

<span class="sb">      .chip.primary {</span>
<span class="sb">        background: rgba(25, 118, 210, 0.16);</span>
<span class="sb">        color: var(--primary-color);</span>
<span class="sb">      }</span>

<span class="sb">      .signal-actions {</span>
<span class="sb">        display: flex;</span>
<span class="sb">        flex-wrap: wrap;</span>
<span class="sb">        gap: 8px;</span>
<span class="sb">      }</span>

<span class="sb">      .signal-chips {</span>
<span class="sb">        display: flex;</span>
<span class="sb">        flex-wrap: wrap;</span>
<span class="sb">        gap: 8px;</span>
<span class="sb">        margin-top: 6px;</span>
<span class="sb">      }</span>

<span class="sb">      .signal-chip {</span>
<span class="sb">        display: flex;</span>
<span class="sb">        flex-direction: column;</span>
<span class="sb">        gap: 4px;</span>
<span class="sb">        padding: 10px;</span>
<span class="sb">        border-radius: 12px;</span>
<span class="sb">        background: rgba(0, 0, 0, 0.03);</span>
<span class="sb">      }</span>

<span class="sb">      .error {</span>
<span class="sb">        color: var(--error-color);</span>
<span class="sb">        margin-bottom: 12px;</span>
<span class="sb">        padding: 12px 16px;</span>
<span class="sb">        background: rgba(244, 67, 54, 0.1);</span>
<span class="sb">        border-radius: 8px;</span>
<span class="sb">        border-left: 4px solid var(--error-color);</span>
<span class="sb">      }</span>

<span class="sb">      .success {</span>
<span class="sb">        color: var(--success-color, var(--success-color-fallback));</span>
<span class="sb">        margin-bottom: 12px;</span>
<span class="sb">        padding: 12px 16px;</span>
<span class="sb">        background: rgba(76, 175, 80, 0.1);</span>
<span class="sb">        border-radius: 8px;</span>
<span class="sb">        border-left: 4px solid var(--success-color, var(--success-color-fallback));</span>
<span class="sb">      }</span>

<span class="sb">      .info {</span>
<span class="sb">        color: var(--info-color, var(--info-color-fallback));</span>
<span class="sb">        margin-bottom: 12px;</span>
<span class="sb">        padding: 12px 16px;</span>
<span class="sb">        background: rgba(33, 150, 243, 0.1);</span>
<span class="sb">        border-radius: 8px;</span>
<span class="sb">        border-left: 4px solid var(--info-color, var(--info-color-fallback));</span>
<span class="sb">      }</span>

<span class="sb">      .required {</span>
<span class="sb">        margin-left: 4px;</span>
<span class="sb">        color: var(--error-color);</span>
<span class="sb">      }</span>

<span class="sb">      .mapping-grid {</span>
<span class="sb">        display: grid;</span>
<span class="sb">        gap: 18px;</span>
<span class="sb">      }</span>

<span class="sb">      .mapping-item {</span>
<span class="sb">        display: grid;</span>
<span class="sb">        gap: 12px;</span>
<span class="sb">        padding: 16px;</span>
<span class="sb">        border-radius: 12px;</span>
<span class="sb">        background: rgba(0, 0, 0, 0.04);</span>
<span class="sb">      }</span>

<span class="sb">      .mapping-actions {</span>
<span class="sb">        display: flex;</span>
<span class="sb">        gap: 12px;</span>
<span class="sb">        flex-wrap: wrap;</span>
<span class="sb">      }</span>

<span class="sb">      mwc-button.danger,</span>
<span class="sb">      mwc-button.danger[unelevated] {</span>
<span class="sb">        --mdc-theme-primary: var(--error-color);</span>
<span class="sb">      }</span>

<span class="sb">      .device-checkboxes {</span>
<span class="sb">        display: flex;</span>
<span class="sb">        flex-wrap: wrap;</span>
<span class="sb">        gap: 8px;</span>
<span class="sb">      }</span>

<span class="sb">      .map-canvas {</span>
<span class="sb">        position: relative;</span>
<span class="sb">        border-radius: 16px;</span>
<span class="sb">        background: linear-gradient(135deg, rgba(0, 150, 136, 0.12), rgba(30, 136, 229, 0.12));</span>
<span class="sb">        padding: 12px;</span>
<span class="sb">        overflow: hidden;</span>
<span class="sb">      }</span>

<span class="sb">      svg.mapping {</span>
<span class="sb">        width: 100%;</span>
<span class="sb">        min-height: 260px;</span>
<span class="sb">      }</span>

<span class="sb">      .category-label {</span>
<span class="sb">        font-size: 0.8rem;</span>
<span class="sb">        font-weight: 600;</span>
<span class="sb">        fill: var(--primary-text-color);</span>
<span class="sb">      }</span>

<span class="sb">      .category-column {</span>
<span class="sb">        fill: rgba(255, 255, 255, 0.35);</span>
<span class="sb">      }</span>

<span class="sb">      .node-label {</span>
<span class="sb">        font-size: 0.75rem;</span>
<span class="sb">        fill: var(--primary-text-color);</span>
<span class="sb">      }</span>

<span class="sb">      .node-circle {</span>
<span class="sb">        fill: var(--accent-color);</span>
<span class="sb">        stroke: rgba(0, 0, 0, 0.2);</span>
<span class="sb">        stroke-width: 1;</span>
<span class="sb">      }</span>

<span class="sb">      @media (max-width: 768px) {</span>
<span class="sb">        :host {</span>
<span class="sb">          padding: 16px;</span>
<span class="sb">        }</span>

<span class="sb">        .actions {</span>
<span class="sb">          justify-content: stretch;</span>
<span class="sb">          flex-direction: column;</span>
<span class="sb">        }</span>

<span class="sb">        .actions mwc-button {</span>
<span class="sb">          width: 100%;</span>
<span class="sb">        }</span>

<span class="sb">        .signal-entry {</span>
<span class="sb">          flex-direction: column;</span>
<span class="sb">          align-items: stretch;</span>
<span class="sb">          gap: 12px;</span>
<span class="sb">        }</span>

<span class="sb">        .split-columns {</span>
<span class="sb">          grid-template-columns: 1fr;</span>
<span class="sb">        }</span>

<span class="sb">        h2.section-title {</span>
<span class="sb">          font-size: 1.2rem;</span>
<span class="sb">        }</span>
<span class="sb">      }</span>

<span class="sb">      .help-text {</span>
<span class="sb">        font-size: 0.85rem;</span>
<span class="sb">        color: var(--secondary-text-color);</span>
<span class="sb">        margin-top: 8px;</span>
<span class="sb">        padding: 8px;</span>
<span class="sb">        background: rgba(0, 0, 0, 0.02);</span>
<span class="sb">        border-radius: 6px;</span>
<span class="sb">      }</span>

<span class="sb">      .help-icon {</span>
<span class="sb">        cursor: help;</span>
<span class="sb">        opacity: 0.6;</span>
<span class="sb">        transition: opacity 0.2s;</span>
<span class="sb">      }</span>

<span class="sb">      .help-icon:hover {</span>
<span class="sb">        opacity: 1;</span>
<span class="sb">      }</span>

<span class="sb">      .button-group {</span>
<span class="sb">        display: flex;</span>
<span class="sb">        gap: 8px;</span>
<span class="sb">        flex-wrap: wrap;</span>
<span class="sb">      }</span>

<span class="sb">      @media (prefers-reduced-motion: reduce) {</span>
<span class="sb">        * {</span>
<span class="sb">          animation: none !important;</span>
<span class="sb">          transition: none !important;</span>
<span class="sb">        }</span>
<span class="sb">      }</span>
<span class="sb">    `</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">learning</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">signals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">devices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">signalMappings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">formType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;switch&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">formName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">formSignals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">formActions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">_configureActionsForType</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">formType</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">formCustomAction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">successMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">infoMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">_signalUnsub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">_learningUnsub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">_persistedMappings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">connectedCallback</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">.</span><span class="nx">connectedCallback</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">_initialize</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">disconnectedCallback</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">.</span><span class="nx">disconnectedCallback</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_signalUnsub</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">_signalUnsub</span><span class="p">();</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">_signalUnsub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_learningUnsub</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">_learningUnsub</span><span class="p">();</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">_learningUnsub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">_initialize</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">_loadState</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">_subscribeSignals</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">_subscribeLearning</span><span class="p">();</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">_refreshDevices</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">_loadState</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">hass</span><span class="p">.</span><span class="nx">callWS</span><span class="p">({</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;raspyrfm/learning/status&quot;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">learning</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">status</span><span class="p">.</span><span class="nx">active</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">signals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">hass</span><span class="p">.</span><span class="nx">callWS</span><span class="p">({</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;raspyrfm/signals/list&quot;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">signals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">_normaliseSignals</span><span class="p">(</span><span class="nx">signals</span><span class="p">.</span><span class="nx">signals</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">[]);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">_loadMappings</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">hass</span><span class="p">.</span><span class="nx">callWS</span><span class="p">({</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;raspyrfm/signals/map/list&quot;</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">      </span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">mappings</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">[]).</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">entry</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">next</span><span class="p">[</span><span class="nx">entry</span><span class="p">.</span><span class="nx">payload</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">entry</span><span class="p">;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">signalMappings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">next</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">_persistedMappings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">next</span><span class="p">));</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">error</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;Signal mapping is temporarily unavailable.&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Older backends might not expose the mapping API yet – degrade gracefully.</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;Unable to load RaspyRFM signal mappings&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">signalMappings</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{}).</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">signalMappings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Signal mapping is temporarily unavailable.&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">_subscribeSignals</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">_signalUnsub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">hass</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">subscribeMessage</span><span class="p">((</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;event&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">signal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">message</span><span class="p">.</span><span class="nx">event</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">signals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">_normaliseSignals</span><span class="p">([...</span><span class="k">this</span><span class="p">.</span><span class="nx">signals</span><span class="p">,</span><span class="w"> </span><span class="nx">signal</span><span class="p">]);</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;raspyrfm/signals/subscribe&quot;</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">_subscribeLearning</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">_learningUnsub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">hass</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">subscribeMessage</span><span class="p">((</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;event&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">learning</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">message</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">active</span><span class="p">;</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;raspyrfm/learning/subscribe&quot;</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">_refreshDevices</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">hass</span><span class="p">.</span><span class="nx">callWS</span><span class="p">({</span><span class="w"> </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;raspyrfm/devices/list&quot;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">devices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">devices</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">_loadMappings</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">render</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">html</span><span class="sb">`</span>
<span class="sb">      &lt;div class=&quot;layout&quot;&gt;</span>
<span class="sb">        &lt;div class=&quot;actions&quot;&gt;</span>
<span class="sb">          &lt;mwc-button raised icon=&quot;mdi:play&quot; @click=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">_handleStartLearning</span><span class="si">}</span><span class="sb"> ?disabled=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">learning</span><span class="si">}</span>
<span class="sb">            &gt;Start learning&lt;/mwc-button</span>
<span class="sb">          &gt;</span>
<span class="sb">          &lt;mwc-button icon=&quot;mdi:stop&quot; @click=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">_handleStopLearning</span><span class="si">}</span><span class="sb"> ?disabled=</span><span class="si">${</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">learning</span><span class="si">}</span>
<span class="sb">            &gt;Stop learning&lt;/mwc-button</span>
<span class="sb">          &gt;</span>
<span class="sb">          &lt;mwc-button icon=&quot;mdi:refresh&quot; @click=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">_refreshDevices</span><span class="si">}</span><span class="sb">&gt;Refresh devices&lt;/mwc-button&gt;</span>
<span class="sb">          &lt;mwc-button icon=&quot;mdi:chart-bubble&quot; @click=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">_loadMappings</span><span class="si">}</span><span class="sb">&gt;Reload mapping&lt;/mwc-button&gt;</span>
<span class="sb">        &lt;/div&gt;</span>
<span class="sb">        </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">html</span><span class="sb">`&lt;div class=&quot;error&quot;&gt;⚠️ </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">error</span><span class="si">}</span><span class="sb">&lt;/div&gt;`</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="si">}</span>
<span class="sb">        </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">successMessage</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">html</span><span class="sb">`&lt;div class=&quot;success&quot;&gt;✓ </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">successMessage</span><span class="si">}</span><span class="sb">&lt;/div&gt;`</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="si">}</span>
<span class="sb">        </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">infoMessage</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">html</span><span class="sb">`&lt;div class=&quot;info&quot;&gt;ℹ️ </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">infoMessage</span><span class="si">}</span><span class="sb">&lt;/div&gt;`</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="si">}</span>
<span class="sb">        </span><span class="si">${</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">learning</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">signals</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">html</span><span class="sb">`</span>
<span class="sb">          &lt;div class=&quot;info&quot;&gt;</span>
<span class="sb">            &lt;strong&gt;Getting Started:&lt;/strong&gt; Click &quot;Start learning&quot; to begin capturing RF signals from your remotes and devices. </span>
<span class="sb">            For Raspberry Pi 4/5 with HAOS, ensure your RaspyRFM gateway is connected and accessible on the network.</span>
<span class="sb">          &lt;/div&gt;</span>
<span class="sb">        `</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="si">}</span>
<span class="sb">        &lt;div class=&quot;split-columns&quot;&gt;</span>
<span class="sb">          </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">_renderSignals</span><span class="p">()</span><span class="si">}</span><span class="sb"> </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">_renderForm</span><span class="p">()</span><span class="si">}</span>
<span class="sb">        &lt;/div&gt;</span>
<span class="sb">        </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">_renderMappingWorkspace</span><span class="p">()</span><span class="si">}</span>
<span class="sb">        </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">_renderDevices</span><span class="p">()</span><span class="si">}</span>
<span class="sb">      &lt;/div&gt;</span>
<span class="sb">    `</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">_renderSignals</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">signals</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">html</span><span class="sb">`</span>
<span class="sb">        &lt;ha-card header=&quot;Captured signals&quot;&gt;</span>
<span class="sb">          &lt;div class=&quot;card-content&quot;&gt;No signals received yet. Use the start learning button and trigger your remotes or sensors.&lt;/div&gt;</span>
<span class="sb">        &lt;/ha-card&gt;</span>
<span class="sb">      `</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">html</span><span class="sb">`</span>
<span class="sb">      &lt;ha-card header=&quot;Captured signals&quot;&gt;</span>
<span class="sb">        &lt;div class=&quot;card-content signal-list&quot;&gt;</span>
<span class="sb">          </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">signals</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">signal</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">_renderSignal</span><span class="p">(</span><span class="nx">signal</span><span class="p">))</span><span class="si">}</span>
<span class="sb">        &lt;/div&gt;</span>
<span class="sb">      &lt;/ha-card&gt;</span>
<span class="sb">    `</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">_renderSignal</span><span class="p">(</span><span class="nx">signal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">actions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">formActions</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">formActions</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">classification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">signal</span><span class="o">?</span><span class="p">.</span><span class="nx">metadata</span><span class="o">?</span><span class="p">.</span><span class="nx">classification</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">classificationActions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">classification</span><span class="o">?</span><span class="p">.</span><span class="nx">actions</span><span class="p">)</span>
<span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="nx">classification</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">action</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">_labelForAction</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_normaliseActionKey</span><span class="p">(</span><span class="nx">action</span><span class="p">)))</span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">html</span><span class="sb">`</span>
<span class="sb">      &lt;div class=&quot;signal-entry&quot;&gt;</span>
<span class="sb">        &lt;div class=&quot;meta-block&quot;&gt;</span>
<span class="sb">          &lt;div&gt;</span><span class="si">${</span><span class="nx">signal</span><span class="p">.</span><span class="nx">payload</span><span class="si">}</span><span class="sb">&lt;/div&gt;</span>
<span class="sb">          &lt;div class=&quot;signal-meta&quot;&gt;</span><span class="si">${</span><span class="nx">signal</span><span class="p">.</span><span class="nx">received</span><span class="si">}</span><span class="sb">&lt;/div&gt;</span>
<span class="sb">          </span><span class="si">${</span><span class="nx">classification</span>
<span class="w">            </span><span class="o">?</span><span class="w"> </span><span class="nx">html</span><span class="sb">`</span>
<span class="sb">                &lt;div class=&quot;signal-chips&quot;&gt;</span>
<span class="sb">                  &lt;span class=&quot;chip primary&quot;&gt;</span><span class="si">${</span><span class="nx">classification</span><span class="p">.</span><span class="nx">suggested_type</span><span class="si">}</span><span class="sb">&lt;/span&gt;</span>
<span class="sb">                  </span><span class="si">${</span><span class="nx">classificationActions</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">label</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">html</span><span class="sb">`&lt;span class=&quot;chip&quot;&gt;</span><span class="si">${</span><span class="nx">label</span><span class="si">}</span><span class="sb">&lt;/span&gt;`</span><span class="p">)</span><span class="w"> </span><span class="si">}</span>
<span class="sb">                &lt;/div&gt;</span>
<span class="sb">              `</span>
<span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="si">}</span>
<span class="sb">        &lt;/div&gt;</span>
<span class="sb">        &lt;div class=&quot;signal-actions&quot;&gt;</span>
<span class="sb">          </span><span class="si">${</span><span class="nx">actions</span><span class="p">.</span><span class="nx">length</span>
<span class="w">            </span><span class="o">?</span><span class="w"> </span><span class="nx">actions</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span>
<span class="w">                </span><span class="p">(</span><span class="nx">action</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">html</span><span class="sb">`</span>
<span class="sb">                  &lt;mwc-button</span>
<span class="sb">                    dense</span>
<span class="sb">                    outlined</span>
<span class="sb">                    @click=</span><span class="si">${</span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">_assignSignal</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">signal</span><span class="p">.</span><span class="nx">payload</span><span class="p">)</span><span class="si">}</span>
<span class="sb">                    &gt;Set as </span><span class="si">${</span><span class="nx">action</span><span class="p">.</span><span class="nx">label</span><span class="si">}</span><span class="sb">&lt;/mwc-button</span>
<span class="sb">                  &gt;</span>
<span class="sb">                `</span><span class="p">,</span>
<span class="w">              </span><span class="p">)</span>
<span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="nx">html</span><span class="sb">`&lt;span class=&quot;signal-meta&quot;&gt;Add an action to the form to assign this payload.&lt;/span&gt;`</span><span class="si">}</span>
</pre></div>
</div>
</section>
<section id="home-assistant-integration-checklist">
<h2>Home Assistant integration checklist<a class="headerlink" href="#home-assistant-integration-checklist" title="Link to this heading">¶</a></h2>
<p>To use the integration in your own Home Assistant instance:</p>
<ol class="arabic simple">
<li><p>Copy the <code class="docutils literal notranslate"><span class="pre">custom_components/raspyrfm</span></code> directory into your Home
Assistant <code class="docutils literal notranslate"><span class="pre">config/custom_components</span></code> folder.</p></li>
<li><p>Restart Home Assistant so the new integration is discovered.</p></li>
<li><p>Navigate to <em>Settings → Devices &amp; Services</em> and add the RaspyRFM
integration.  Provide the host name or IP address of the RaspyRFM
gateway and the UDP port it listens on (<code class="docutils literal notranslate"><span class="pre">49880</span></code> by default).</p></li>
<li><p>Open the <em>RaspyRFM</em> panel from the sidebar to start a learning session
and capture payloads.  Use the <em>Create Home Assistant device</em> card to
turn them into entities, then link payloads to devices in the mapping
workspace.</p></li>
<li><p>Optional: update the labels, categories, and device associations for
each payload in the mapping workspace.  The data is persisted through
<code class="docutils literal notranslate"><span class="pre">.storage/raspyrfm_signal_map</span></code> and is restored after Home Assistant
restarts.</p></li>
</ol>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="raspyrfm_hardware_setup.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">RaspyRFM Hardware Installation Guide</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="index.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">RaspyRFM Client Manual</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2017, Markus Ressel
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Home Assistant Components</a><ul>
<li><a class="reference internal" href="#configuration-flow-and-setup">Configuration flow and setup</a></li>
<li><a class="reference internal" href="#gateway-and-hub-orchestration">Gateway and hub orchestration</a></li>
<li><a class="reference internal" href="#signal-learning-pipeline">Signal learning pipeline</a></li>
<li><a class="reference internal" href="#persistent-storage-and-device-registry">Persistent storage and device registry</a></li>
<li><a class="reference internal" href="#entity-platforms">Entity platforms</a></li>
<li><a class="reference internal" href="#websocket-api-surface">Websocket API surface</a></li>
<li><a class="reference internal" href="#panel-registration-and-static-assets">Panel registration and static assets</a></li>
<li><a class="reference internal" href="#frontend-component">Frontend component</a></li>
<li><a class="reference internal" href="#home-assistant-integration-checklist">Home Assistant integration checklist</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=dc1923a2"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    </body>
</html>